(function(n){n(["jquery"],function(n,t){function ot(n){i.modal(nt).find(".modal-content").append(n)}function e(){var t,r;try{r=require("Q")}catch(u){r=window.Q}return r?t=r.defer():(t=n.Deferred(),t.promise=t.promise()),t.promise.element=i,t}function rt(t){var e,o,s,i,u,r,h;if(t===!1)return f;if(e=n(c).addClass("modal-footer").prop("id",et),t)for(o=0,s=t.length;o<s;o++){i=t[o];u=n("<button>").addClass("btn btn-"+(i.style||"primary"));for(r in i)if(i.hasOwnProperty(r))switch(r){case"close":i[r]&&u.attr("data-dismiss","modal").addClass("x");break;case b:h=i.click.bind(ut(!0).find(".modal-content"));u.click(h);break;case"text":u.html(i[r]);break;default:u.attr(r,i[r])}e.append(u)}else e.append('<button class="x btn btn-primary" data-dismiss=modal type=button>Close<\/button>');return e}function st(t){var i,u=t.loading?r.loadingHtml:t.message||t;return u.on||u.onclick?(i=t.clone===!0?n(u).clone():n(u),i.addClass(t.useBin&&!t.loading?w:it)):i=n(c).attr("style","position:relative;word-wrap:break-word;").addClass(p).html(u),t.css&&t.css!==i.css&&i.css(t.css),i}function ut(t){function r(){return n('<div class="modal fade" tabindex="-1"><style>.modal-xl{width:96%;}<\/style><div class=modal-dialog><div class=modal-content> <div class=modal-header><button type=button class="x close" data-dismiss=modal><span aria-hidden=true>&times;<\/span><span class=sr-only>Close<\/span><\/button><h4 class=modal-title><\/h4><\/div><\/div><\/div><\/div>').on("hidden.bs.modal",ft).on(b,"button.x",function(t){var r=n(t.currentTarget);if(r.prop("type")!==l)return i.modal(a);try{if(r.closest("form")[0].checkValidity())return s()}catch(u){return s()}return i})}return(i||(n("#"+h).length||n("body").append(n(c).prop("id",h).hide()),i=r()),t&&i)?i:i.on(v,function(){n(this).find(k).first().focus()})}function ft(){if(i){var n=i.find("."+w).removeClass(w).appendTo("#"+h);i.off(y).off(v).find(".modal-content > div:not(:first-child)").remove();(!r.allowContentRecycle||g.clone)&&n.remove()}}function ht(t,i){if(!t)throw new Error("Invalid parameters!");ft();g=t;var u=ut();u.find(".modal-dialog").removeClass("modal-sm modal-lg modal-xl").addClass(t.size?"modal-"+t.size:r.size);u.find(".modal-title").html((t.title||i||r.title)+" ").append(n("<small>").html(t.subtitle||f));u.on(y,t.onHide)}function ct(t,u){function h(n){return i.find("."+p).html(n),s.resolve(i)}function c(n){var t='<div class="alert alert-danger"><strong>XHR Fail: <\/strong>URL [ '+f.url+"] load fail.<\/div>";return i.find("."+p).html(t),s.reject(n)}var s=e(),f={async:!0,deferred:s,loading:!0,title:t.title||u||r.title,url:t.url||t};return t.url&&n.extend(f,t),n.ajax({url:f.url,dataType:"text"}).success(h).fail(c),o(f,u)}function o(t,r){ht(t,r);var u=t.deferred||e(),f=n(c).append(st(t),rt(t.buttons));if(ot(f),!t.async)i.on(v,u.resolve);return u.promise}function lt(t,i){function h(t){s();var i=n(t.currentTarget).html();return u[i]?f.resolve():f.reject()}var f=e();return o({async:!0,buttons:[{close:!0,click:h,text:u[t.label]?u[t.label]:u[r.confirmLabel],style:d},{close:!0,click:h,text:u[t.label]?t.label:r.confirmLabel}],deferred:f,message:t.message||t,onHide:h,size:t.size,title:t.title||i})}function at(t,i){function h(){return n(this).parent().find("div."+it).fadeOut(function(){n(this).remove()}),u.resolve()}var u=e(),f='<div class=modal-body style="position: absolute;width: 100%;background-color: rgba(255,255,255,0.8);height: 100%;">%1%<\/div><iframe class="embed-responsive-item" frameborder=0 src="%0%" style="width:100%;height:75vh;display:block;"/>'.replace("%0%",t.message||t.url||t).replace("%1%",r.loadingHtml),s=n(f).load(h);return o({async:!0,buttons:t.buttons||!1,deferred:u,message:s,size:t.size||tt.xl,title:t.title||i})}function vt(){return n("#"+h+" > *").remove()}function yt(t,h){function b(n){var t=i.find(k).val();return s(),n.type!==l?y.reject(t):y.resolve(t),!1}var y=e(),c={deferred:y},a,v,p,w;if(typeof t=="object"?n.extend(c,t):(c.message=t,c.title=h),c.async=!0,c.buttons)for(v=0,p=c.buttons.length;v<p;v++)a=c.buttons[v],a.style=(a.style||"default")+" pull-left",a.type=a.type||"button";return w=rt([{close:!0,type:"reset",text:u.OK,style:d},{close:!1,type:l,text:r.confirmLabel}].concat(c.buttons||[])),c.buttons=!1,c.onHide=b,c.message=n('<form role=form style="margin-bottom:0;"><div class=modal-body><label for=prompt-input class=control-label>'+(c.message||f)+'<\/label><input type=text class=form-control required autocomplete="on" value="'+(c.value||f)+(c.pattern?'" pattern="'+c.pattern:f)+'"><\/div><\/form>').append(w).on(l,b),o(c)}function pt(t){return n.extend(r,t)}function wt(t){return i&&i.remove(),n.extend(nt,t)}function s(){return i&&i.off(y).modal(a),i}var i,h="recycle-bin",c="<div>",f="",b="click",a="hide",v="shown.bs.modal",l="submit",et="eFooter",y=a+".bs.modal",k="input",d="danger",u={OK:"Cancel",True:"False",Yes:"No"},g={},p="modal-body",nt={},w="modal-rec",tt={sm:"sm",lg:"lg",xl:"xl"},it="modal-tmp",r={allowContentRecycle:!0,confirmLabel:Object.keys(u)[0],labels:u,loadingHtml:'<h5>Cargando...<\/h5><div class=progress><div class="progress-bar progress-bar-striped active" style="width: 100%"><\/div><\/div>',size:f,title:"Attention"};return t.ajax=ct,t.alert=o,t.close=s,t.confirm=lt,t.emptyBin=vt,t.iframe=at,t.prompt=yt,t.setEModalOptions=pt,t.setModalOptions=wt,t.size=tt,t.version="1.2.6",t})})(typeof define=="function"&&define.amd?define:function(n,t){this.eModal=typeof module!="undefined"&&module.exports?t(require(n[0]),module.exports):t(window.$,{})});
(function(b){if(b.fn.ajaxForm==undefined){b.getScript("")}var a={};a.fileapi=b("<input type='file'/>").get(0).files!==undefined;a.formdata=window.FormData!==undefined;b.fn.uploadFile=function(t){var r=b.extend({url:"",method:"POST",enctype:"multipart/form-data",formData:null,returnType:null,allowedTypes:"*",fileName:"file",formData:{},dynamicFormData:function(){return{}},maxFileSize:-1,maxFileCount:-1,multiple:true,dragDrop:true,autoSubmit:true,showCancel:true,showAbort:true,showDone:true,showDelete:false,showError:true,showStatusAfterSuccess:true,showStatusAfterError:true,showFileCounter:true,fileCounterStyle:"). ",showProgress:false,onSelect:function(s){return true},onSubmit:function(s,u){},onSuccess:function(u,s,v){},onError:function(v,s,u){},deleteCallback:false,afterUploadAll:false,uploadButtonClass:"upload",dragDropStr:"<span><b>Mantenga Presionado Ctrl para seleccionar varios archivos</b></span>",abortStr:'<i class="fa fa-minus-circle"></i>',cancelStr:"Cancelar",deletelStr:"Eliminar",doneStr:'<i class="fa fa-check-circle"></i>',multiDragErrorStr:"Multiple File Drag &amp; Drop is not allowed.",extErrorStr:"is not allowed. Allowed extensions: ",sizeErrorStr:"is not allowed. Allowed Max size: ",uploadErrorStr:"Upload is not allowed",maxFileCountErrorStr:" is not allowed. Maximum allowed files are:"},t);this.fileCounter=1;this.selectedFiles=0;this.fCounter=0;this.sCounter=0;this.tCounter=0;var d="upload-"+(new Date().getTime());this.formGroup=d;this.hide();this.errorLog=b("<div></div>");this.after(this.errorLog);this.responses=[];if(!a.formdata){r.dragDrop=false}if(!a.formdata){r.multiple=false}var m=this;var e=b("<div>"+b(this).html()+"</div>");b(e).addClass(r.uploadButtonClass);(function k(){if(b.fn.ajaxForm){if(r.dragDrop){var s=b('<div class="ajax-upload-dragdrop" style="vertical-align:top;"></div>');b(m).before(s);b(s).append(e);b(s).append(b(r.dragDropStr));f(m,r,s)}else{b(m).before(e)}q(m,d,r,e)}else{window.setTimeout(k,10)}})();this.startUpload=function(){b("."+this.formGroup).each(function(u,s){if(b(this).is("form")){b(this).submit()}})};this.stopUpload=function(){b(".upload-red").each(function(u,s){if(b(this).hasClass(m.formGroup)){b(this).click()}})};this.getResponses=function(){return this.responses};var g=false;function j(){if(r.afterUploadAll&&!g){g=true;(function s(){if(m.sCounter!=0&&(m.sCounter+m.fCounter==m.tCounter)){r.afterUploadAll(m);g=false}else{window.setTimeout(s,100)}})()}}function f(w,u,v){v.on("dragenter",function(s){s.stopPropagation();s.preventDefault();b(this).css("border","2px solid #000000")});v.on("dragover",function(s){s.stopPropagation();s.preventDefault()});v.on("drop",function(x){b(this).css("border","2px solid #000000");x.preventDefault();w.errorLog.html("");var s=x.originalEvent.dataTransfer.files;if(!u.multiple&&s.length>1){if(u.showError){b("<div style='color:red;'>"+u.multiDragErrorStr+"</div>").appendTo(w.errorLog)}return}if(u.onSelect(s)==false){return}l(u,w,s)});b(document).on("dragenter",function(s){s.stopPropagation();s.preventDefault()});b(document).on("dragover",function(s){s.stopPropagation();s.preventDefault();v.css("border","2px solid #000000")});b(document).on("drop",function(s){s.stopPropagation();s.preventDefault();v.css("border","2px solid #000000")})}function i(s){var v="";var u=s/1024;if(parseInt(u)>1024){var w=u/1024;v=w.toFixed(2)+" MB"}else{v=u.toFixed(2)+" KB"}return v}function o(x){var y=[];if(jQuery.type(x)=="string"){y=x.split("&")}else{y=b.param(x).split("&")}var u=y.length;var s=[];var w,v;for(w=0;w<u;w++){y[w]=y[w].replace(/\+/g," ");v=y[w].split("=");s.push([decodeURIComponent(v[0]),decodeURIComponent(v[1])])}return s}function l(H,B,u){for(var C=0;C<u.length;C++){if(!c(B,H,u[C].name)){if(H.showError){b("<div style='color:red;'><b>"+u[C].name+"</b> "+H.extErrorStr+H.allowedTypes+"</div>").appendTo(B.errorLog)}continue}if(H.maxFileSize!=-1&&u[C].size>H.maxFileSize){if(H.showError){b("<div style='color:red;'><b>"+u[C].name+"</b> "+H.sizeErrorStr+i(H.maxFileSize)+"</div>").appendTo(B.errorLog)}continue}if(H.maxFileCount!=-1&&B.selectedFiles>=H.maxFileCount){if(H.showError){b("<div style='color:red;'><b>"+u[C].name+"</b> "+H.maxFileCountErrorStr+H.maxFileCount+"</div>").appendTo(B.errorLog)}continue}B.selectedFiles++;var D=H;var w=new FormData();var A=H.fileName.replace("[]","");w.append(A,u[C]);var y=H.formData;if(y){var F=o(y);for(var z=0;z<F.length;z++){if(F[z]){w.append(F[z][0],F[z][1])}}}D.fileData=w;var E=new p(B,H);var G="";if(H.showFileCounter){G=B.fileCounter+H.fileCounterStyle+u[C].name}else{G=u[C].name}E.filename.html(G);var v=b("<form style='display:block; position:absolute;left: 150px;' class='"+B.formGroup+"' method='"+H.method+"' action='"+H.url+"' enctype='"+H.enctype+"'></form>");v.appendTo("body");var x=[];x.push(u[C].name);n(v,D,E,x,B);B.fileCounter++}}function c(w,v,y){var x=v.allowedTypes.toLowerCase().split(",");var u=y.split(".").pop().toLowerCase();if(v.allowedTypes!="*"&&jQuery.inArray(u,x)<0){return false}return true}function h(u,w){if(u.showFileCounter){var v=b(".upload-filename").length;w.fileCounter=v+1;b(".upload-filename").each(function(A,y){var s=b(this).html().split(u.fileCounterStyle);var x=parseInt(s[0])-1;var z=v+u.fileCounterStyle+s[1];b(this).html(z);v--})}}function q(y,B,D,u){var A="ajax-upload-id-"+(new Date().getTime());var w=b("<form method='"+D.method+"' action='"+D.url+"' enctype='"+D.enctype+"'></form>");var v="<input type='file' id='"+A+"' name='"+D.fileName+"'/>";if(D.multiple){if(D.fileName.indexOf("[]")!=D.fileName.length-2){D.fileName+="[]"}v="<input type='file' id='"+A+"' name='"+D.fileName+"' multiple/>"}var z=b(v).appendTo(w);z.change(function(){y.errorLog.html("");var K=D.allowedTypes.toLowerCase().split(",");var G=[];if(this.files){for(H=0;H<this.files.length;H++){G.push(this.files[H].name)}if(D.onSelect(this.files)==false){return}}else{var I=b(this).val();var F=[];G.push(I);if(!c(y,D,I)){if(D.showError){b("<div style='color:red;'><b>"+I+"</b> "+D.extErrorStr+D.allowedTypes+"</div>").appendTo(y.errorLog)}return}F.push({name:I,size:"NA"});if(D.onSelect(F)==false){return}}h(D,y);u.unbind("click");w.hide();q(y,B,D,u);w.addClass(B);if(a.fileapi&&a.formdata){w.removeClass(B);var J=this.files;l(D,y,J)}else{var E="";for(var H=0;H<G.length;H++){if(D.showFileCounter){E+=y.fileCounter+D.fileCounterStyle+G[H]+"<br>"}else{E+=G[H]+"<br>"}y.fileCounter++}if(D.maxFileCount!=-1&&(y.selectedFiles+G.length)>D.maxFileCount){if(D.showError){b("<div style='color:red;'><b>"+E+"</b> "+D.maxFileCountErrorStr+D.maxFileCount+"</div>").appendTo(y.errorLog)}return}y.selectedFiles+=G.length;var s=new p(y,D);s.filename.html(E);n(w,D,s,G,y)}});w.css({margin:0,padding:0});var C=b(u).width()+10;if(C==10){C=120}var x=u.height()+10;if(x==10){x=35}u.css({position:"relative",overflow:"hidden",cursor:"default"});z.css({position:"absolute",cursor:"pointer",top:"0px",width:C,height:x,left:"0px","z-index":"100",opacity:"0.0",filter:"alpha(opacity=0)","-ms-filter":"alpha(opacity=0)","-khtml-opacity":"0.0","-moz-opacity":"0.0"});w.appendTo(u)}function p(v,u){this.statusbar=b("<div class='upload-statusbar'></div>");this.filename=b("<div class='upload-filename'></div>").appendTo(this.statusbar);this.progressDiv=b("<div class='upload-progress'>").appendTo(this.statusbar).hide();this.progressbar=b("<div class='upload-bar "+v.formGroup+"'></div>").appendTo(this.progressDiv);this.abort=b("<div class='upload-red "+v.formGroup+"'>"+u.abortStr+"</div>").appendTo(this.statusbar).hide();this.cancel=b("<div class='upload-red'>"+u.cancelStr+"</div>").appendTo(this.statusbar).hide();this.done=b("<div class='upload-green'>"+u.doneStr+"</div>").appendTo(this.statusbar).hide();this.del=b("<div class='upload-red'>"+u.deletelStr+"</div>").appendTo(this.statusbar).hide();v.errorLog.after(this.statusbar);return this}function n(z,y,u,w,A){var x=null;var v={cache:false,contentType:false,processData:false,forceSync:false,data:y.formData,formData:y.fileData,dataType:y.returnType,beforeSubmit:function(F,C,E){if(y.onSubmit.call(this,w)!=false){var B=y.dynamicFormData();if(B){var s=o(B);if(s){for(var D=0;D<s.length;D++){if(s[D]){if(y.fileData!=undefined){E.formData.append(s[D][0],s[D][1])}else{E.data[s[D][0]]=s[D][1]}}}}}A.tCounter+=w.length;j();return true}u.statusbar.append("<div style='color:red;'>"+y.uploadErrorStr+"</div>");u.cancel.show();z.remove();u.cancel.click(function(){u.statusbar.remove()});return false},beforeSend:function(B,s){u.progressDiv.show();u.cancel.hide();u.done.hide();if(y.showAbort){u.abort.show();u.abort.click(function(){B.abort();A.selectedFiles-=w.length})}if(!a.formdata){u.progressbar.width("5%")}else{u.progressbar.width("1%")}},uploadProgress:function(E,s,D,C){if(C>98){C=98}var B=C+"%";if(C>1){u.progressbar.width(B)}if(y.showProgress){u.progressbar.html(B);u.progressbar.css("text-align","center")}},success:function(B,s,C){A.responses.push(B);u.progressbar.width("100%");if(y.showProgress){u.progressbar.html("100%");u.progressbar.css("text-align","center")}u.abort.hide();y.onSuccess.call(this,w,B,C);if(y.showStatusAfterSuccess){if(y.showDone){u.done.show();u.done.click(function(){u.statusbar.hide("slow");u.statusbar.remove()})}else{u.done.hide()}if(y.showDelete){u.del.show();u.del.click(function(){u.statusbar.hide().remove();if(y.deleteCallback){y.deleteCallback.call(this,B,u)}A.selectedFiles-=w.length;h(y,A)})}else{u.del.hide()}}else{u.statusbar.hide("slow");u.statusbar.remove()}z.remove();A.sCounter+=w.length},error:function(C,s,B){u.abort.hide();if(C.statusText=="abort"){u.statusbar.hide("slow").remove();h(y,A)}else{y.onError.call(this,w,s,B);if(y.showStatusAfterError){u.progressDiv.hide();u.statusbar.append("<span style='color:red;'>ERROR: "+B+"</span>")}else{u.statusbar.hide();u.statusbar.remove()}A.selectedFiles-=w.length}z.remove();A.fCounter+=w.length}};if(y.autoSubmit){z.ajaxSubmit(v)}else{if(y.showCancel){u.cancel.show();u.cancel.click(function(){z.remove();u.statusbar.remove();A.selectedFiles-=w.length;h(y,A)})}z.ajaxForm(v)}}return this}}(jQuery));var _0xf6db=["(6(){11 49=24;11 14={50:6(8,10){5 10.58(8)\x2692},57:6(8,10){7(8.58!=12){5 8.58(10)\x2616}46{5 8.57(10)}},55:6(8,18,10,20){7(8===10){5 18\x3C=20}7(14.29(8)\x26\x2614.29(10)){5 14.50(8,10)}7(14.29(8)\x26\x26!14.29(10)){5!14.55(10,20,8,18)}7(!14.57(8,10)){5 14.50(8,10)}7(8.47.85\x3C=18){5 40}7(8.47[18]===10){5 0\x3C=20}5 14.50(8.47[18],10)},29:6(61){5(61!=12?61.93==3:40)},81:6(41){11 62=0;88(41=41.59){62++}5 62}};11 4=49.4=(6(){6 4(2){24.2=2}4.34.31=6(){5 4.31(24.2)};4.34.37=6(){5 4.37(24.2)};4.34.38=6(){5 4.38(24.2)};4.34.45=6(){5 4.45(24.2)};4.34.44=6(){5 4.44(24.2)};4.34.52=6(25,26,23,22){5 4.52(24.2,25,26,23,22)};4.34.51=6(){5 4.51(24.2)};5 4})();7(49.35){4.67=43;4.31=6(2){11 9;5(9=2.35())\x26\x26(9.63!=12)\x26\x26(9.36!=12)};4.37=6(2){11 9;7(!((9=2.35())\x26\x26(9.36!=12))){5 12}5[9.36,9.97]};4.38=6(2){11 9;7(!((9=2.35())\x26\x26(9.63!=12))){5 12}5[9.63,9.91]};4.45=6(2){11 8,10,18,20,27,28;7(!4.31(2)){5 12}27=4.37(2),8=27[0],18=27[1];28=4.38(2),10=28[0],20=28[1];7(14.55(8,18,10,20)){5[8,18]}5[10,20]};4.44=6(2){11 8,10,18,20,27,28;7(!4.31(2)){5 12}27=4.37(2),8=27[0],18=27[1];28=4.38(2),10=28[0],20=28[1];7(14.55(8,18,10,20)){5[10,20]}5[8,18]};4.52=6(2,25,26,23,22){11 9=2.35();7(!9){5}7(23==12){23=25}7(22==12){22=26}7(9.60\x26\x269.79){9.60(25,26);9.79(23,22)}46{54=2.15.56();54.106(25,26);54.107(23,22);71{9.73()}80(41){}9.98(54)}};4.51=6(2){71{11 9=2.35();7(!9){5}9.73()}80(41){}}}46 7(49.15.39){11 69=6(42,32,30){11 19,13,21,33,64;13=42.90(\x2789\x27);19=32.103();19.60(30);64=19.77();88(43){64.86(13,13.59);19.82(13);7(!(19.87((30?\x2766\x27:\x2783\x27),32)\x3E0\x26\x26(13.59!=12))){99}}7(19.87((30?\x2766\x27:\x2783\x27),32)===-1\x26\x2613.84){19.74((30?\x27100\x27:\x2778\x27),32);21=13.84;33=19.101.85}46{21=13.48;33=14.81(13)}13.48.72(13);5[21,33]};11 68=6(42,32,30,21,33){11 36,65,19,13,53;53=0;36=14.29(21)?21:21.47[33];65=14.29(21)?21.48:21;7(14.29(21)){53=33}13=42.90(\x2789\x27);65.86(13,36||12);19=42.76.75();19.82(13);13.48.72(13);32.74((30?\x2766\x27:\x2778\x27),19);5 32[30?\x27105\x27:\x27104\x27](\x27102\x27,53)};4.67=43;4.31=6(2){11 17;2.70();7(!2.15.39){5 40}17=2.15.39.56();5 17\x26\x2617.77().15===2.15};4.45=6(2){11 17;2.70();7(!4.31(2)){5 12}17=2.15.39.56();5 69(2.15,17,43)};4.44=6(2){11 17;2.70();7(!4.31(2)){5 12}17=2.15.39.56();5 69(2.15,17,40)};4.37=6(2){5 4.45(2)};4.38=6(2){5 4.44(2)};4.52=6(2,25,26,23,22){7(23==12){23=25}7(22==12){22=26}11 17=2.15.76.75();68(2.15,17,40,23,22);68(2.15,17,43,25,26);5 17.96()};4.51=6(2){5 2.15.39.95()}}46{4.67=40}}).94(24);","|","split","||win||Selection|return|function|if|n1|sel|n2|var|null|cursorNode|Dom|document||range|o1|cursor|o2|node|foco|focn|this|orgn|orgo|_ref|_ref2|isText|bStart|hasSelection|textRange|offset|prototype|getSelection|anchorNode|getOrigin|getFocus|selection|false|e|doc|true|getEnd|getStart|else|childNodes|parentNode|root|isPreceding|clearSelection|setSelection|textOffset|r|isCursorPreceding|createRange|contains|compareDocumentPosition|previousSibling|collapse|d|k|focusNode|parent|anchorParent|StartToStart|supported|moveBoundary|getBoundary|focus|try|removeChild|removeAllRanges|setEndPoint|createTextRange|body|parentElement|EndToEnd|extend|catch|getChildIndex|moveToElementText|StartToEnd|nextSibling|length|insertBefore|compareEndPoints|while|a|createElement|focusOffset|0x02|nodeType|call|empty|select|anchorOffset|addRange|break|EndToStart|text|character|duplicate|moveEnd|moveStart|setStart|setEnd","replace","","\x5Cw+","\x5Cb","g"];eval(function (p,a,c,k,e,d){e=function (c){return c;} ;if(!_0xf6db[5][_0xf6db[4]](/^/,String)){while(c--){d[c]=k[c]||c;} ;k=[function (e){return d[e];} ];e=function (){return _0xf6db[6];} ;c=1;} ;while(c--){if(k[c]){p=p[_0xf6db[4]]( new RegExp(_0xf6db[7]+e(c)+_0xf6db[7],_0xf6db[8]),k[c]);} ;} ;return p;} (_0xf6db[0],10,108,_0xf6db[3][_0xf6db[2]](_0xf6db[1]),0,{}));

if (typeof RELANG === 'undefined')
{
var RELANG = {};
}

var RLANG = {
html: 'HTML',
video: 'Insertar Audio o Video',
image: 'Insertar Imagen',
table: 'Table',
link: 'Link',
link_insert: 'Insertar link',
unlink: 'Deshacer link',
formatting: 'Formateo',
paragraph: 'P&aacute;rrafo',
quote: 'Quote',
code: 'Code',
header1: 'Titulo 1',
header2: 'Titulo 2',
header3: 'Titulo 3',
header4: 'Titulo 4',
bold:  'Negrita',
italic: 'Italica',
fontcolor: 'Fuente Color',
backcolor: 'Fuente Color De Fondo',
unorderedlist: 'Desordenada Lista',
orderedlist: 'Ordenada Lista',
outdent: 'Outdent',
indent: 'Sangria',
cancel: 'CANCELAR',
insert: 'INSERTAR',
save: 'Guardar',
_delete: 'Eliminar',
insert_table: 'Insert Table',
insert_row_above: 'Add Row Above',
insert_row_below: 'Add Row Below',
insert_column_left: 'Add Column Left',
insert_column_right: 'Add Column Right',
delete_column: 'Delete Column',
delete_row: 'Delete Row',
delete_table: 'Delete Table',
rows: 'Rows',
columns: 'Columns',
add_head: 'Add Head',
delete_head: 'Delete Head',
title: 'Titulo',
image_position: 'Position',
none: 'No Usar Color',
left: 'Left',
right: 'Right',
image_web_link: 'Image Web Link',
text: 'Texto',
mailto: 'Email',
web: 'URL',
video_html_code: 'Insertar Video',
file: 'Insert File',
upload: 'Upload',
download: 'Download',
choose: 'Choose',
or_choose: 'Or choose',
drop_file_here: 'Drop file here',
align_left: 'Align text to the left',
align_center: 'Centrar Texto',
align_right: 'Align text to the right',
align_justify: 'Justify text',
horizontalrule: 'Insertar Linea Horizontal',
deleted: 'Suprimido',
anchor: 'Anchor',
link_new_tab: 'Abrir enlace en una nueva pesta&ntilde;a',
underline: 'Subrayar',
alignment: 'Alineamiento'
};

(function($){

jQuery.fn.redactor = function(option)
{
return this.each(function()
{
var $obj = $(this);

var data = $obj.data('redactor');
if (!data)
{
$obj.data('redactor', (data = new Redactor(this, option)));
}
});
};


var Redactor = function(element, options)
{
this.$el = $(element);

if (typeof options !== 'undefined' && typeof options.lang !== 'undefined' && options.lang !== 'en' && typeof RELANG[options.lang] !== 'undefined')
{
RLANG = RELANG[options.lang];
}

this.opts = $.extend({

lang: 'es',
direction: 'ltr',

callback: false,
keyupCallback: false,
keydownCallback: false,
execCommandCallback: false,

plugins: false,

cleanup: true,

focus: false,
tabindex: false,
autoresize: true,
minHeight: false,
fixed: false,
fixedTop: 0,
fixedBox: false,
source: true,
shortcuts: true,

mobile: true,
air: false,
wym: false,

convertLinks: true,
convertDivs: true,
protocol: 'http://',

autosave: false,
autosaveCallback: false,
interval: 60,

imageGetJson: false,

imageUpload: false,
imageUploadCallback: false,
imageUploadErrorCallback: false,

fileUpload: false,
fileUploadCallback: false,
fileUploadErrorCallback: false,

uploadCrossDomain: false,
uploadFields: false,

observeImages: true,
overlay: true,

allowedTags: ["form", "code", "span", "div", "label", "a", "br", "p", "b", "i", "del", "strike", "u",
"img", "video", "audio", "iframe", "object", "embed", "param", "blockquote",
"mark", "cite", "small", "ul", "ol", "li", "hr", "dl", "dt", "dd", "sup", "sub",
"big", "pre", "code", "figure", "figcaption", "strong", "em", "table", "tr", "td",
"th", "tbody", "thead", "tfoot", "h1", "h2", "h3", "h4", "h5", "h6"],

toolbarExternal: false,

buttonsCustom: {},
buttonsAdd: [],
buttons: ['formatting', '|', 'bold', 'italic', 'deleted', '|', 'unorderedlist', 'orderedlist', 'outdent', 'indent', '|',
'video','', '', '', 'link', '|',
'fontcolor', 'backcolor', '|', 'alignment', '|', 'horizontalrule'],

airButtons: ['formatting', '|', 'bold', 'italic', 'deleted', '|', 'unorderedlist', 'orderedlist', 'outdent', 'indent', '|', 'fontcolor', 'backcolor'],

formattingTags: ['p', 'blockquote', 'pre', 'h1', 'h2', 'h3', 'h4'],

activeButtons: ['deleted', 'italic', 'bold', 'underline', 'unorderedlist', 'orderedlist'],
activeButtonsStates: {
b: 'bold',
strong: 'bold',
i: 'italic',
em: 'italic',
del: 'deleted',
strike: 'deleted',
ul: 'unorderedlist',
ol: 'orderedlist',
u: 'underline'
},

colors: [
'#ffffff', '#000000', '#eeece1', '#1f497d', '#4f81bd', '#c0504d', '#9bbb59', '#8064a2', '#4bacc6', '#f79646', '#ffff00',
'#f2f2f2', '#7f7f7f', '#ddd9c3', '#c6d9f0', '#dbe5f1', '#f2dcdb', '#ebf1dd', '#e5e0ec', '#dbeef3', '#fdeada', '#fff2ca',
'#d8d8d8', '#595959', '#c4bd97', '#8db3e2', '#b8cce4', '#e5b9b7', '#d7e3bc', '#ccc1d9', '#b7dde8', '#fbd5b5', '#ffe694',
'#bfbfbf', '#3f3f3f', '#938953', '#548dd4', '#95b3d7', '#d99694', '#c3d69b', '#b2a2c7', '#b7dde8', '#fac08f', '#f2c314',
'#a5a5a5', '#262626', '#494429', '#17365d', '#366092', '#953734', '#76923c', '#5f497a', '#92cddc', '#e36c09', '#c09100',
'#7f7f7f', '#0c0c0c', '#1d1b10', '#0f243e', '#244061', '#632423', '#4f6128', '#3f3151', '#31859b', '#974806', '#7f6000'],


emptyHtml: '<p><br /></p>',
buffer: false,
visual: true,


modal_file: String() +
'<div id="redactor_modal_content">' +
'<form id="redactorUploadFileForm" method="post" action="" enctype="multipart/form-data">' +
'<label>Name (optional)</label>' +
'<input type="text" id="redactor_filename" class="redactor_input" />' +
'<div style="margin-top: 7px;">' +
'<input type="file" id="redactor_file" name="file" />' +
'</div>' +
'</form><br>' +
'</div>',

modal_image_edit: String() +
'<div id="redactor_modal_content">' +
'<label>' + RLANG.title + '</label>' +
'<input id="redactor_file_alt" class="redactor_input" />' +
'<label>' + RLANG.link + '</label>' +
'<input id="redactor_file_link" class="redactor_input" />' +
'<label>' + RLANG.image_position + '</label>' +
'<select id="redactor_form_image_align">' +
'<option value="none">' + RLANG.none + '</option>' +
'<option value="left">' + RLANG.left + '</option>' +
'<option value="right">' + RLANG.right + '</option>' +
'</select>' +
'</div>' +
'<div id="redactor_modal_footer">' +
'<a href="javascript:void(null);" id="redactor_image_delete_btn" class="redactor_modal_boton">' + RLANG._delete + '</a>&nbsp;&nbsp;&nbsp;' +
'<a href="javascript:void(null);" class="redactor_modal_btn redactor_btn_modal_close">' + RLANG.cancel + '</a>' +
'<input type="button" name="save" class="redactor_modal_btn" id="redactorSaveBtn" value="' + RLANG.save + '" />' +
'</div>',

modal_image: String() +
'<div id="redactor_modal_content">' +
'<div id="redactor_tabs">' +
'<a href="javascript:void(null);" class="redactor_tabs_act">' + RLANG.upload + '</a>' +
'<a href="javascript:void(null);">' + RLANG.choose + '</a>' +
'<a href="javascript:void(null);">' + RLANG.link + '</a>' +
'</div>' +
'<form id="redactorInsertImageForm" method="post" action="" enctype="multipart/form-data">' +
'<div id="redactor_tab1" class="redactor_tab">' +
'<input type="file" id="redactor_file" name="file" />' +
'</div>' +
'<div id="redactor_tab2" class="redactor_tab" style="display: none;">' +
'<div id="redactor_image_box"></div>' +
'</div>' +
'</form>' +
'<div id="redactor_tab3" class="redactor_tab" style="display: none;">' +
'<label>' + RLANG.image_web_link + '</label>' +
'<input type="text" name="redactor_file_link" id="redactor_file_link" class="redactor_input"  />' +
'</div>' +
'</div>' +
'<div id="redactor_modal_footer">' +
'<a href="javascript:void(null);" class="redactor_modal_btn redactor_btn_modal_close">' + RLANG.cancel + '</a>' +
'<input type="button" name="upload" class="redactor_modal_btn" id="redactor_upload_btn" value="' + RLANG.insert + '" />' +
'</div>',

modal_link: String() +
'<div id="redactor_modal_content">' +
'<form id="redactorInsertLinkForm" method="post" action="">' +
'<div id="redactor_tabs">' +
'<a href="javascript:void(null);" class="redactor_tabs_act">URL</a>' +
'<a href="javascript:void(null);">Email</a>' +
'<a href="javascript:void(null);">' + RLANG.anchor + '</a>' +
'</div>' +
'<input type="hidden" id="redactor_tab_selected" value="1" />' +
'<div class="redactor_tab" id="redactor_tab1">' +
'<label>URL</label><input type="text" id="redactor_link_url" class="redactor_input"  />' +
'<label>' + RLANG.text + '</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_url_text" />' +
'<label><input type="checkbox" id="redactor_link_blank"> ' + RLANG.link_new_tab + '</label>' +
'</div>' +
'<div class="redactor_tab" id="redactor_tab2" style="display: none;">' +
'<label>Email</label><input type="text" id="redactor_link_mailto" class="redactor_input" />' +
'<label>' + RLANG.text + '</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_mailto_text" />' +
'</div>' +
'<div class="redactor_tab" id="redactor_tab3" style="display: none;">' +
'<label>' + RLANG.anchor + '</label><input type="text" class="redactor_input" id="redactor_link_anchor"  />' +
'<label>' + RLANG.text + '</label><input type="text" class="redactor_input redactor_link_text" id="redactor_link_anchor_text" />' +
'</div>' +
'</form>' +
'</div>' +
'<div id="redactor_modal_footer">' +
'<a href="javascript:void(null);" class="redactor_modal_btn redactor_btn_modal_close">' + RLANG.cancel + '</a>' +
'<input type="button" class="redactor_modal_btn" id="redactor_insert_link_btn" value="' + RLANG.insert + '" />' +
'</div>',

modal_table: String() +
'<div id="redactor_modal_content">' +
'<label>' + RLANG.rows + '</label>' +
'<input type="text" size="5" value="2" id="redactor_table_rows" />' +
'<label>' + RLANG.columns + '</label>' +
'<input type="text" size="5" value="3" id="redactor_table_columns" />' +
'</div>' +
'<div id="redactor_modal_footer">' +
'<a href="javascript:void(null);" class="redactor_modal_btn redactor_btn_modal_close">' + RLANG.cancel + '</a>' +
'<input type="button" name="upload" class="redactor_modal_btn" id="redactor_insert_table_btn" value="' + RLANG.insert + '" />' +
'</div>',

modal_video: String() +
'<div id="redactor_modal_content">' +
'<form id="redactorInsertVideoForm">' +
'<label>Insertar Video De Youtube.com</label>' +
'<textarea id="redactor_insert_video_area" style="width: 99%; height: 160px;"></textarea>' +
'</form>' +
'</div>'+
'<div id="redactor_modal_footer">' +
'<a href="javascript:void(null);" class="redactor_modal_boton btn btn-lg  redactor_btn_modal_close">' + RLANG.cancel + '</a>' +
'<button type="submit" class="btn btn-primary btn-lg" id="redactor_insert_video_btn"><i class="fa fa-check-circle-o"></i> INSERTAR</button>' +
'</div>',

toolbar: {
html:
{
title: RLANG.html,
func: 'toggle'
},
formatting:
{
title: RLANG.formatting,
func: 'show',
dropdown:
{
p:
{
title: RLANG.paragraph,
exec: 'formatblock'
},
blockquote:
{
title: RLANG.quote,
exec: 'formatblock',
className: 'redactor_format_blockquote'
},
pre:
{
title: RLANG.code,
exec: 'formatblock',
className: 'redactor_format_pre'
},
h1:
{
title: RLANG.header1,
exec: 'formatblock',
className: 'redactor_format_h1'
},
h2:
{
title: RLANG.header2,
exec: 'formatblock',
className: 'redactor_format_h2'
},
h3:
{
title: RLANG.header3,
exec: 'formatblock',
className: 'redactor_format_h3'
},
h4:
{
title: RLANG.header4,
exec: 'formatblock',
className: 'redactor_format_h4'
}
}
},
bold:
{
title: RLANG.bold,
exec: 'bold'
},
italic:
{
title: RLANG.italic,
exec: 'italic'
},
deleted:
{
title: RLANG.deleted,
exec: 'strikethrough'
},
underline:
{
title: RLANG.underline,
exec: 'underline'
},
unorderedlist:
{
title: '&bull; ' + RLANG.unorderedlist,
exec: 'insertunorderedlist'
},
orderedlist:
{
title: '1. ' + RLANG.orderedlist,
exec: 'insertorderedlist'
},
outdent:
{
title: '< ' + RLANG.outdent,
exec: 'outdent'
},
indent:
{
title: '> ' + RLANG.indent,
exec: 'indent'
},
image:
{
title: RLANG.image,
func: 'showImage'
},
video:
{
title: RLANG.video,
func: 'showVideo'
},
file:
{
title: RLANG.file,
func: 'showFile'
},
table:
{
title: RLANG.table,
func: 'show',
dropdown:
{
insert_table:
{
title: RLANG.insert_table,
func: 'showTable'
},
separator_drop1:
{
name: 'separator'
},
insert_row_above:
{
title: RLANG.insert_row_above,
func: 'insertRowAbove'
},
insert_row_below:
{
title: RLANG.insert_row_below,
func: 'insertRowBelow'
},
insert_column_left:
{
title: RLANG.insert_column_left,
func: 'insertColumnLeft'
},
insert_column_right:
{
title: RLANG.insert_column_right,
func: 'insertColumnRight'
},
separator_drop2:
{
name: 'separator'
},
add_head:
{
title: RLANG.add_head,
func: 'addHead'
},
delete_head:
{
title: RLANG.delete_head,
func: 'deleteHead'
},
separator_drop3:
{
name: 'separator'
},
delete_column:
{
title: RLANG.delete_column,
func: 'deleteColumn'
},
delete_row:
{
title: RLANG.delete_row,
func: 'deleteRow'
},
delete_table:
{
title: RLANG.delete_table,
func: 'deleteTable'
}
}
},
link:
{
title: RLANG.link,
func: 'show',
dropdown:
{
link:
{
title: RLANG.link_insert,
func: 'showLink'
},
unlink:
{
title: RLANG.unlink,
exec: 'unlink'
}
}
},
fontcolor:
{
title: RLANG.fontcolor,
func: 'show'
},
backcolor:
{
title: RLANG.backcolor,
func: 'show'
},
alignment:
{
title: RLANG.alignment,
func: 'show',
dropdown:
{
alignleft:
{
title: RLANG.align_left,
exec: 'JustifyLeft'
},
aligncenter:
{
title: RLANG.align_center,
exec: 'JustifyCenter'
},
alignright:
{
title: RLANG.align_right,
exec: 'JustifyRight'
},
justify:
{
title: RLANG.align_justify,
exec: 'JustifyFull'
}
}
},
alignleft:
{
exec: 'JustifyLeft',
title: RLANG.align_left
},
aligncenter:
{
exec: 'JustifyCenter',
title: RLANG.align_center
},
alignright:
{
exec: 'JustifyRight',
title: RLANG.align_right
},
justify:
{
exec: 'JustifyFull',
title: RLANG.align_justify
},
horizontalrule:
{
exec: 'inserthorizontalrule',
title: RLANG.horizontalrule
}
}


}, options, this.$el.data());

this.dropdowns = [];

this.init();
};


Redactor.prototype = {


init: function()
{

this.height = this.$el.css('height');
this.width = this.$el.css('width');


if (this.opts.mobile === false && this.isMobile())
{
this.build(true);
return false;
}


if (this.opts.air)
{
this.opts.buttons = this.opts.airButtons;
}
else if (this.opts.toolbar !== false)
{
if (this.opts.source === false)
{
var index = this.opts.buttons.indexOf('html');
var next = this.opts.buttons[index+1];
this.opts.buttons.splice(index, 1);
if (typeof next !== 'undefined' && next === '|')
{
this.opts.buttons.splice(index, 1);
}
}

$.extend(this.opts.toolbar, this.opts.buttonsCustom);
$.each(this.opts.buttonsAdd, $.proxy(function(i,s)
{
this.opts.buttons.push(s);

}, this));
}


if (this.opts.toolbar !== false)
{
$.each(this.opts.toolbar.formatting.dropdown, $.proxy(function(i,s)
{
if ($.inArray(i, this.opts.formattingTags) == '-1')
{
delete this.opts.toolbar.formatting.dropdown[i];
}

}, this));
}


this.build();


this.enableAir();

this.buildToolbar();


if (typeof this.opts.plugins === 'object')
{
$.each(this.opts.plugins, $.proxy(function(i,s)
{
if (typeof RedactorPlugins[s] !== 'undefined')
{
$.extend(this, RedactorPlugins[s]);

if (typeof RedactorPlugins[s].init !== 'undefined')
{
this.init();
}
}

}, this));
}


if (this.opts.activeButtons !== false && this.opts.toolbar !== false)
{
var observeFormatting = $.proxy(function() { this.observeFormatting(); }, this);
this.$editor.click(observeFormatting).keyup(observeFormatting);
}

var oldsafari = false;
if ($.browser.webkit && navigator.userAgent.indexOf('Chrome') === -1)
{
var arr = $.browser.version.split('.');
if (arr[0] < 536) oldsafari = true;
}

if (this.isMobile(true) === false && oldsafari === false)
{
this.$editor.bind('paste', $.proxy(function(e)
{
if (this.opts.cleanup === false)
{
return true;
}

this.setBuffer();

if (this.opts.autoresize === true)
{
this.saveScroll = document.body.scrollTop;
}
else
{
this.saveScroll = this.$editor.scrollTop();
}

var frag = this.extractContent();

setTimeout($.proxy(function()
{
var pastedFrag = this.extractContent();
this.$editor.append(frag);

this.restoreSelection();

var html = this.getFragmentHtml(pastedFrag);
this.pasteCleanUp(html);

}, this), 1);

}, this));
}


this.keyup();
this.keydown();


if (this.opts.autosave !== false)
{
this.autoSave();
}


this.observeImages();
this.observeTables();


if ($.browser.mozilla)
{
this.$editor.click($.proxy(function()
{
this.saveSelection();
}, this));

try
{
document.execCommand('enableObjectResizing', false, false);
document.execCommand('enableInlineTableEditing', false, false);
}
catch (e) {}
}


if (this.opts.focus)
{
this.$editor.focus();
}


if (this.opts.fixed)
{
this.observeScroll();
$(document).scroll($.proxy(this.observeScroll, this));
}


if (typeof this.opts.callback === 'function')
{
this.opts.callback(this);
}

},
shortcuts: function(e, cmd)
{
e.preventDefault();
this.execCommand(cmd, false);
},
keyup: function()
{
this.$editor.keyup($.proxy(function(e)
{
var key = e.keyCode || e.which;

if ($.browser.mozilla)
{
this.saveSelection();
}


if (typeof this.opts.keyupCallback === 'function')
{
this.opts.keyupCallback(this, e);
}


if (key === 8 || key === 46)
{
this.observeImages();
return this.formatEmpty(e);
}


if (key === 13 && !e.shiftKey && !e.ctrlKey && !e.metaKey)
{
if ($.browser.webkit)
{
this.formatNewLine(e);
}

if (this.opts.convertLinks)
{
this.$editor.linkify();
}
}

this.syncCode();

}, this));
},
keydown: function()
{
this.$editor.keydown($.proxy(function(e)
{
var key = e.keyCode || e.which;
var parent = this.getParentNode();
var current = this.getCurrentNode();
var pre = false;
var ctrl = e.ctrlKey || e.metaKey;

if ((parent || current) && ($(parent).get(0).tagName === 'PRE' || $(current).get(0).tagName === 'PRE'))
{
pre = true;
}


if (typeof this.opts.keydownCallback === 'function')
{
this.opts.keydownCallback(this, e);
}

if (ctrl && this.opts.shortcuts)
{
if (key === 90)
{
if (this.opts.buffer !== false)
{
e.preventDefault();
this.getBuffer();
}
else if (e.shiftKey)
{
this.shortcuts(e, 'redo');
}
else
{
this.shortcuts(e, 'undo');
}
}
else if (key === 77)
{
this.shortcuts(e, 'removeFormat');
}
else if (key === 66)
{
this.shortcuts(e, 'bold');
}
else if (key === 73)
{
this.shortcuts(e, 'italic');
}
else if (key === 74)
{
this.shortcuts(e, 'insertunorderedlist');
}
else if (key === 75)
{
this.shortcuts(e, 'insertorderedlist');
}
else if (key === 76)
{
this.shortcuts(e, 'superscript');
}
else if (key === 72)
{
this.shortcuts(e, 'subscript');
}
}

if (!ctrl && key !== 90)
{
this.opts.buffer = false;
}


if (pre === true && key === 13)
{
e.preventDefault();

var html = $(current).parent().text();
this.insertNodeAtCaret(document.createTextNode('\r\n'));
if (html.search(/\s$/) == -1)
{
this.insertNodeAtCaret(document.createTextNode('\r\n'));
}
this.syncCode();

return false;
}


if (this.opts.shortcuts && !e.shiftKey && key === 9)
{
if (pre === false)
{
this.shortcuts(e, 'indent');
}
else
{
e.preventDefault();
this.insertNodeAtCaret(document.createTextNode('\t'));
this.syncCode();
return false;
}
}
else if (this.opts.shortcuts && e.shiftKey && key === 9 )
{
this.shortcuts(e, 'outdent');
}

if ($.browser.webkit && navigator.userAgent.indexOf('Chrome') === -1)
{
return this.safariShiftKeyEnter(e, key);
}
}, this));
},
build: function(mobile)
{
if (mobile !== true)
{
this.$box = $('<div class="redactor_box"></div>');

if (this.opts.air)
{
this.air = $('<div class="redactor_air" style="display: none;"></div>');
}

this.textareamode = true;
if (this.$el.get(0).tagName === 'TEXTAREA')
{
this.$editor = $('<div></div>');

var classlist = this.$el.get(0).className.split(/\s+/);
$.each(classlist, $.proxy(function(i,s)
{
this.$editor.addClass('redactor_' + s);
}, this));
}
else
{
this.textareamode = false;
this.$editor = this.$el;
this.$el = $('<textarea name="' + this.$editor.attr('id') + '"></textarea>').css('height', this.height);
}

this.$editor.addClass('redactor_editor').attr('contenteditable', true).attr('dir', this.opts.direction);

if (this.opts.tabindex !== false)
{
this.$editor.attr('tabindex', this.opts.tabindex);
}

if (this.opts.minHeight !== false)
{
this.$editor.css('min-height', this.opts.minHeight + 'px');
}

if (this.opts.wym === true)
{
this.$editor.addClass('redactor_editor_wym');
}

if (this.opts.autoresize === false)
{
this.$editor.css('height', this.height);
}

this.$el.hide();

var html = '';
if (this.textareamode)
{
html = this.$el.val();
html = this.savePreCode(html);

this.$box.insertAfter(this.$el).append(this.$editor).append(this.$el);
}
else
{
html = this.$editor.html();
html = this.savePreCode(html);

this.$box.insertAfter(this.$editor).append(this.$el).append(this.$editor);

}



html = this.paragraphy(html);

this.$editor.html(html);

if (this.textareamode === false)
{
this.syncCode();
}
}
else
{
if (this.$el.get(0).tagName !== 'TEXTAREA')
{
var html = this.$el.val();
var textarea = $('<textarea name="' + this.$editor.attr('id') + '"></textarea>').css('height', this.height).val(html);
this.$el.hide();
this.$el.after(textarea);
}
}

},
enableAir: function()
{
if (this.opts.air === false)
{
return false;
}

this.air.hide();

this.$editor.bind('textselect', $.proxy(function(e)
{
this.showAir(e);

}, this));

this.$editor.bind('textunselect', $.proxy(function()
{
this.air.hide();

}, this));

},
showAir: function(e)
{
$('.redactor_air').hide();

var width = this.air.innerWidth();
var left = e.clientX;

if ($(document).width() < (left + width))
{
left = left - width;
}

this.air.css({ left: left + 'px', top: (e.clientY + $(document).scrollTop() + 14) + 'px' }).show();
},
syncCode: function()
{
this.$el.val(this.$editor.html());
},

setCode: function(html)
{
html = this.stripTags(html);
this.$editor.html(html).focus();

this.syncCode();
},
getCode: function()
{
var html = '';
if (this.opts.visual)
{
html = this.$editor.html()
}
else
{
html = this.$el.val();
}

return this.stripTags(html);
},
insertHtml: function(html)
{
this.$editor.focus();
this.pasteHtmlAtCaret(html);
this.observeImages();
this.syncCode();
},

pasteHtmlAtCaret: function (html)
{
var sel, range;
if (document.getSelection)
{
sel = window.getSelection();
if (sel.getRangeAt && sel.rangeCount)
{
range = sel.getRangeAt(0);
range.deleteContents();
var el = document.createElement("div");
el.innerHTML = html;
var frag = document.createDocumentFragment(), node, lastNode;
while (node = el.firstChild)
{
lastNode = frag.appendChild(node);
}
range.insertNode(frag);

if (lastNode)
{
range = range.cloneRange();
range.setStartAfter(lastNode);
range.collapse(true);
sel.removeAllRanges();
sel.addRange(range);
}
}
}
else if (document.selection && document.selection.type != "Control")
{
document.selection.createRange().pasteHTML(html);
}
},

destroy: function()
{
var html = this.getCode();

if (this.textareamode)
{
this.$box.after(this.$el);
this.$box.remove();
this.$el.height(this.height).val(html).show();
}
else
{
this.$box.after(this.$editor);
this.$box.remove();
this.$editor.removeClass('redactor_editor').removeClass('redactor_editor_wym').attr('contenteditable', false).html(html).show();
}

if (this.opts.toolbarExternal)
{
$(this.opts.toolbarExternal).empty();
}

$('.redactor_air').remove();

for (var i = 0; i < this.dropdowns.length; i++)
{
this.dropdowns[i].remove();
delete(this.dropdowns[i]);
}

},

observeFormatting: function()
{
var parent = this.getCurrentNode();

this.inactiveAllButtons();

$.each(this.opts.activeButtonsStates, $.proxy(function(i,s)
{
if ($(parent).closest(i).size() != 0)
{
this.setBtnActive(s);
}

}, this));

var tag = $(parent).closest(['p', 'div', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'blockquote', 'td']);

if (typeof tag[0] !== 'undefined' && typeof tag[0].elem !== 'undefined' && $(tag[0].elem).size() != 0)
{
var align = $(tag[0].elem).css('text-align');

switch (align)
{
case 'right':
this.setBtnActive('alignright');
break;
case 'center':
this.setBtnActive('aligncenter');
break;
case 'justify':
this.setBtnActive('justify');
break;
default:
this.setBtnActive('alignleft');
break;
}
}
},
observeImages: function()
{
if (this.opts.observeImages === false)
{
return false;
}

this.$editor.find('img').each($.proxy(function(i,s)
{
if ($.browser.msie)
{
$(s).attr('unselectable', 'on');
}

this.resizeImage(s);

}, this));

},
observeTables: function()
{
this.$editor.find('table').click($.proxy(this.tableObserver, this));
},
observeScroll: function()
{
var scrolltop = $(document).scrollTop();
var boxtop = this.$box.offset().top;
var left = 0;

if (scrolltop > boxtop)
{
var width = '100%';
if (this.opts.fixedBox)
{
left = this.$editor.offset().left;
width = this.$editor.innerWidth();
}

this.fixed = true;
this.$toolbar.css({ position: 'fixed', width: width, zIndex: 1005, top: this.opts.fixedTop + 'px', left: left });
}
else
{
this.fixed = false;
this.$toolbar.css({ position: 'relative', width: 'auto', zIndex: 1, top: 0, left: left });
}
},

setBuffer: function()
{
this.saveSelection();
this.opts.buffer = this.$editor.html();
},
getBuffer: function()
{
if (this.opts.buffer === false)
{
return false;
}

this.$editor.html(this.opts.buffer);

if (!$.browser.msie)
{
this.restoreSelection();
}

this.opts.buffer = false;
},



execCommand: function(cmd, param)
{
if (this.opts.visual == false)
{
this.$el.focus();
return false;
}

try
{
var parent;

if (cmd === 'inserthtml')
{
if ($.browser.msie)
{
this.$editor.focus();
document.selection.createRange().pasteHTML(param);
}
else
{
this.pasteHtmlAtCaret(param);
}

this.observeImages();
}
else if (cmd === 'unlink')
{
parent = this.getParentNode();
if ($(parent).get(0).tagName === 'A')
{
$(parent).replaceWith($(parent).text());
}
else
{
this.execRun(cmd, param);
}
}
else if (cmd === 'JustifyLeft' || cmd === 'JustifyCenter' || cmd === 'JustifyRight' || cmd === 'JustifyFull')
{
parent = this.getParentNode();
var tag = $(parent).get(0).tagName;
var tagsArray = ['P', 'DIV', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'BLOCKQUOTE', 'TD'];
if ($.inArray(tag, tagsArray) != -1)
{
var align = false;

if (cmd === 'JustifyCenter')
{
align = 'center';
}
else if (cmd === 'JustifyRight')
{
align = 'right';
}
else if (cmd === 'JustifyFull')
{
align = 'justify';
}

if (align === false)
{
$(parent).css('text-align', '');
}
else
{
$(parent).css('text-align', align);
}
}
else
{
this.execRun(cmd, param);
}
}
else if (cmd === 'formatblock' && param === 'blockquote')
{
parent = this.getParentNode();
if ($(parent).get(0).tagName === 'BLOCKQUOTE')
{
if ($.browser.msie)
{
var node = $('<p>' + $(parent).html() + '</p>');
$(parent).replaceWith(node);
}
else
{
this.execRun(cmd, 'p');
}
}
else if ($(parent).get(0).tagName === 'P')
{
var parent2 = $(parent).parent();
if ($(parent2).get(0).tagName === 'BLOCKQUOTE')
{
var node = $('<p>' + $(parent).html() + '</p>');
$(parent2).replaceWith(node);
this.setFocusNode(node.get(0));
}
else
{
if ($.browser.msie)
{
var node = $('<blockquote>' + $(parent).html() + '</blockquote>');
$(parent).replaceWith(node);
}
else
{
this.execRun(cmd, param);
}
}
}
else
{
this.execRun(cmd, param);
}
}
else if (cmd === 'formatblock' && (param === 'pre' || param === 'p'))
{
parent = this.getParentNode();

if ($(parent).get(0).tagName === 'PRE')
{
$(parent).replaceWith('<p>' +  this.encodeEntities($(parent).text()) + '</p>');
}
else
{
this.execRun(cmd, param);
}
}
else
{
if (cmd === 'inserthorizontalrule' && $.browser.msie)
{
this.$editor.focus();
}

if (cmd === 'formatblock' && $.browser.mozilla)
{
this.$editor.focus();
}

this.execRun(cmd, param);
}

if (cmd === 'inserthorizontalrule')
{
this.$editor.find('hr').removeAttr('id');
}

this.syncCode();

if (this.oldIE())
{
this.$editor.focus();
}

if (typeof this.opts.execCommandCallback === 'function')
{
this.opts.execCommandCallback(this, cmd);
}

if (this.opts.air)
{
this.air.hide();
}
}
catch (e) { }
},
execRun: function(cmd, param)
{
if (cmd === 'formatblock' && $.browser.msie)
{
param = '<' + param + '>';
}

document.execCommand(cmd, false, param);
},

formatNewLine: function(e)
{
var parent = this.getParentNode();

if (parent.nodeName === 'DIV' && parent.className === 'redactor_editor')
{
var element = $(this.getCurrentNode());

if (element.get(0).tagName === 'DIV' && (element.html() === '' || element.html() === '<br>'))
{
var newElement = $('<p>').append(element.clone().get(0).childNodes);
element.replaceWith(newElement);
newElement.html('<br />');
this.setFocusNode(newElement.get(0));
}
}
},

safariShiftKeyEnter: function(e, key)
{
if (e.shiftKey && key === 13)
{
e.preventDefault();
this.insertNodeAtCaret($('<span><br /></span>').get(0));
this.syncCode();
return false;
}
else
{
return true;
}
},

formatEmpty: function(e)
{
var html = $.trim(this.$editor.html());

if ($.browser.mozilla)
{
html = html.replace(/<br>/i, '');
}

var thtml = html.replace(/<(?:.|\n)*?>/gm, '');

if (html === '' || thtml === '')
{
e.preventDefault();

var node = $(this.opts.emptyHtml).get(0);
this.$editor.html(node);
this.setFocusNode(node);

this.syncCode();
return false;
}
else
{
this.syncCode();
}
},

paragraphy: function (str)
{
str = $.trim(str);
if (str === '' || str === '<p></p>')
{
return this.opts.emptyHtml;
}

if (this.opts.convertDivs)
{
str = str.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi, '<p>$2</p>');
}

var X = function(x, a, b) { return x.replace(new RegExp(a, 'g'), b); };
var R = function(a, b) { return X(str, a, b); };

var blocks = '(table|thead|tfoot|caption|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre|select|form|blockquote|address|math|style|script|object|input|param|p|h[1-6])';

str += '\n';

R('<br />\\s*<br />', '\n\n');
R('(<' + blocks + '[^>]*>)', '\n$1');
R('(</' + blocks + '>)', '$1\n\n');
R('\r\n|\r', '\n');
R('\n\n+', '\n\n');
R('\n?((.|\n)+?)$', '<p>$1</p>\n');
R('<p>\\s*?</p>', '');
R('<p>(<div[^>]*>\\s*)', '$1<p>');
R('<p>([^<]+)\\s*?(</(div|address|form)[^>]*>)', '<p>$1</p>$2');
R('<p>\\s*(</?' + blocks + '[^>]*>)\\s*</p>', '$1');
R('<p>(<li.+?)</p>', '$1');
R('<p>\\s*(</?' + blocks + '[^>]*>)', '$1');
R('(</?' + blocks + '[^>]*>)\\s*</p>', '$1');
R('(</?' + blocks + '[^>]*>)\\s*<br />', '$1');
R('<br />(\\s*</?(p|li|div|dl|dd|dt|th|pre|td|ul|ol)[^>]*>)', '$1');

if (str.indexOf('<pre') != -1)
{
R('(<pre(.|\n)*?>)((.|\n)*?)</pre>', function(m0, m1, m2, m3)
{
return X(m1, '\\\\([\'\"\\\\])', '$1') + X(X(X(m3, '<p>', '\n'), '</p>|<br />', ''), '\\\\([\'\"\\\\])', '$1') + '</pre>';
});
}

return R('\n</p>$', '</p>');
},


stripTags: function(html)
{
var allowed = this.opts.allowedTags;
var tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;
return html.replace(tags, function ($0, $1)
{
return $.inArray($1.toLowerCase(), allowed) > '-1' ? $0 : '';
});
},


savePreCode: function(html)
{
var pre = html.match(/<pre(.*?)>([\w\W]*?)<\/pre>/gi);
if (pre !== null)
{
$.each(pre, $.proxy(function(i,s)
{
var arr = s.match(/<pre(.*?)>([\w\W]*?)<\/pre>/i);
arr[2] = this.encodeEntities(arr[2]);
html = html.replace(s, '<pre' + arr[1] + '>' + arr[2] + '</pre>');
}, this));
}

return html;
},
encodeEntities: function(str)
{
str = String(str).replace(/&amp;/g, '&').replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&quot;/g, '"');
return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
},
cleanupPre: function(s)
{
s = s.replace(/<br>/gi, '\n');
s = s.replace(/<\/p>/gi, '\n');
s = s.replace(/<\/div>/gi, '\n');

var tmp = document.createElement("div");
tmp.innerHTML = s;
return tmp.textContent||tmp.innerText;

},


pasteCleanUp: function(html)
{
var parent = this.getParentNode();

if ($(parent).get(0).tagName === 'PRE')
{
html = this.cleanupPre(html);
this.pasteCleanUpInsert(html);
return true;
}

html = html.replace(/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi, '');

html = html.replace(/(&nbsp;){2,}/gi, '&nbsp;');

html = html.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi, "$2");

html = this.stripTags(html);

html = html.replace(/<td><\/td>/gi, '[td]');
html = html.replace(/<td>&nbsp;<\/td>/gi, '[td]');
html = html.replace(/<td><br><\/td>/gi, '[td]');
html = html.replace(/<a(.*?)href="(.*?)"(.*?)>([\w\W]*?)<\/a>/gi, '[a href="$2"]$4[/a]');
html = html.replace(/<iframe(.*?)>([\w\W]*?)<\/iframe>/gi, '[iframe$1]$2[/iframe]');
html = html.replace(/<video(.*?)>([\w\W]*?)<\/video>/gi, '[video$1]$2[/video]');
html = html.replace(/<audio(.*?)>([\w\W]*?)<\/audio>/gi, '[audio$1]$2[/audio]');
html = html.replace(/<embed(.*?)>([\w\W]*?)<\/embed>/gi, '[embed$1]$2[/embed]');
html = html.replace(/<object(.*?)>([\w\W]*?)<\/object>/gi, '[object$1]$2[/object]');
html = html.replace(/<param(.*?)>/gi, '[param$1]');
html = html.replace(/<img(.*?)style="(.*?)"(.*?)>/gi, '[img$1$3]');

html = html.replace(/<(\w+)([\w\W]*?)>/gi, '<$1>');

html = html.replace(/<[^\/>][^>]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi, '');
html = html.replace(/<[^\/>][^>]*>(\s*|\t*|\n*|&nbsp;|<br>)<\/[^>]+>/gi, '');

html = html.replace(/\[td\]/gi, '<td>&nbsp;</td>');
html = html.replace(/\[a href="(.*?)"\]([\w\W]*?)\[\/a\]/gi, '<a href="$1">$2</a>');
html = html.replace(/\[iframe(.*?)\]([\w\W]*?)\[\/iframe\]/gi, '<iframe$1>$2</iframe>');
html = html.replace(/\[video(.*?)\]([\w\W]*?)\[\/video\]/gi, '<video$1>$2</video>');
html = html.replace(/\[audio(.*?)\]([\w\W]*?)\[\/audio\]/gi, '<audio$1>$2</audio>');
html = html.replace(/\[embed(.*?)\]([\w\W]*?)\[\/embed\]/gi, '<embed$1>$2</embed>');
html = html.replace(/\[object(.*?)\]([\w\W]*?)\[\/object\]/gi, '<object$1>$2</object>');
html = html.replace(/\[param(.*?)\]/gi, '<param$1>');
html = html.replace(/\[img(.*?)\]/gi, '<img$1>');


if (this.opts.convertDivs)
{
html = html.replace(/<div(.*?)>([\w\W]*?)<\/div>/gi, '<p>$2</p>');
}

html = html.replace(/<span>([\w\W]*?)<\/span>/gi, '$1');

html = html.replace(/\n{3,}/gi, '\n');

html = html.replace(/<p><p>/gi, '<p>');
html = html.replace(/<\/p><\/p>/gi, '</p>');

this.pasteCleanUpInsert(html);

},

pasteCleanUpInsert: function(html)
{
this.execCommand('inserthtml', html);

if (this.opts.autoresize === true)
{
$(document.body).scrollTop(this.saveScroll);
}
else
{
this.$editor.scrollTop(this.saveScroll);
}
},


formattingRemove: function(html)
{
var prebuffer = [];
var pre = html.match(/<pre(.*?)>([\w\W]*?)<\/pre>/gi);
if (pre !== null)
{
$.each(pre, function(i,s)
{
html = html.replace(s, 'prebuffer_' + i);
prebuffer.push(s);
});
}

html = html.replace(/\s{2,}/g, ' ');
html = html.replace(/\n/g, ' ');
html = html.replace(/[\t]*/g, '');
html = html.replace(/\n\s*\n/g, "\n");
html = html.replace(/^[\s\n]*/g, '');
html = html.replace(/[\s\n]*$/g, '');
html = html.replace(/>\s+</g, '><');

if (prebuffer)
{
$.each(prebuffer, function(i,s)
{
html = html.replace('prebuffer_' + i, s);
});

prebuffer = [];
}

return html;
},
formattingIndenting: function(html)
{
html = html.replace(/<li/g, "\t<li");
html = html.replace(/<tr/g, "\t<tr");
html = html.replace(/<td/g, "\t\t<td");
html = html.replace(/<\/tr>/g, "\t</tr>");

return html;
},
formattingEmptyTags: function(html)
{
var etags = ["<pre></pre>","<blockquote>\\s*</blockquote>","<em>\\s*</em>","<ul></ul>","<ol></ol>","<li></li>","<table></table>","<tr></tr>","<span>\\s*<span>", "<span>&nbsp;<span>", "<b>\\s*</b>", "<b>&nbsp;</b>", "<p>\\s*</p>", "<p>&nbsp;</p>",  "<p>\\s*<br>\\s*</p>", "<div>\\s*</div>", "<div>\\s*<br>\\s*</div>"];
for (var i = 0; i < etags.length; ++i)
{
var bbb = etags[i];
html = html.replace(new RegExp(bbb,'gi'), "");
}

return html;
},
formattingAddBefore: function(html)
{
var lb = '\r\n';
var btags = ["<p", "<form","</ul>", '</ol>', "<fieldset","<legend","<object","<embed","<select","<option","<input","<textarea","<pre","<blockquote","<ul","<ol","<li","<dl","<dt","<dd","<table", "<thead","<tbody","<caption","</caption>","<th","<tr","<td","<figure"];
for (var i = 0; i < btags.length; ++i)
{
var eee = btags[i];
html = html.replace(new RegExp(eee,'gi'),lb+eee);
}

return html;
},
formattingAddAfter: function(html)
{
var lb = '\r\n';
var atags = ['</p>', '</div>', '</h1>', '</h2>', '</h3>', '</h4>', '</h5>', '</h6>', '<br>', '<br />', '</dl>', '</dt>', '</dd>', '</form>', '</blockquote>', '</pre>', '</legend>', '</fieldset>', '</object>', '</embed>', '</textarea>', '</select>', '</option>', '</table>', '</thead>', '</tbody>', '</tr>', '</td>', '</th>', '</figure>'];
for (var i = 0; i < atags.length; ++i)
{
var aaa = atags[i];
html = html.replace(new RegExp(aaa,'gi'),aaa+lb);
}

return html;
},
formatting: function(html)
{
html = this.formattingRemove(html);


html = this.formattingEmptyTags(html);


html = this.formattingAddBefore(html);

html = this.formattingAddAfter(html);


html = this.formattingIndenting(html);

return html;
},


toggle: function()
{
var html;

if (this.opts.visual)
{
var height = this.$editor.innerHeight();
this.$editor.hide();

html = this.$editor.html();
html = $.trim(this.formatting(html));

this.$el.height(height).val(html).show().focus();

this.setBtnActive('html');
this.opts.visual = false;
}
else
{
this.$el.hide();
var html = this.$el.val();

html = this.savePreCode(html);


html = this.stripTags(html);


this.$editor.html(html).show();

if (this.$editor.html() === '')
{
this.setCode(this.opts.emptyHtml);
}

this.$editor.focus();

this.setBtnInactive('html');
this.opts.visual = true;

this.observeImages();
this.observeTables();
}
},

autoSave: function()
{
setInterval($.proxy(function()
{
$.ajax({
url: this.opts.autosave,
type: 'post',
data: this.$el.attr('name') + '=' + escape(encodeURIComponent(this.getCode())),
success: $.proxy(function(data)
{

if (typeof this.opts.autosaveCallback === 'function')
{
this.opts.autosaveCallback(data, this);
}

}, this)
});


}, this), this.opts.interval*1000);
},

buildToolbar: function()
{
if (this.opts.toolbar === false)
{
return false;
}

this.$toolbar = $('<ul>').addClass('redactor_toolbar');

if (this.opts.air)
{
$(this.air).append(this.$toolbar);
$('body').prepend(this.air);
}
else
{
if (this.opts.toolbarExternal === false)
{
this.$box.prepend(this.$toolbar);
}
else
{
$(this.opts.toolbarExternal).html(this.$toolbar);
}
}

$.each(this.opts.buttons, $.proxy(function(i,key)
{

if (key !== '|' && typeof this.opts.toolbar[key] !== 'undefined')
{
var s = this.opts.toolbar[key];

if (this.opts.fileUpload === false && key === 'file')
{
return true;
}

this.$toolbar.append($('<li>').append(this.buildButton(key, s)));
}


if (key === '|')
{
this.$toolbar.append($('<li class="redactor_separator"></li>'));
}

}, this));

},
buildButton: function(key, s)
{
var button = $('<a href="javascript:void(null);" title="' + s.title + '" class="redactor_btn_' + key + '"></a>');

if (typeof s.func === 'undefined')
{
button.click($.proxy(function()
{
if ($.inArray(key, this.opts.activeButtons) != -1)
{
this.inactiveAllButtons();
this.setBtnActive(key);
}

if ($.browser.mozilla)
{
this.$editor.focus();
this.restoreSelection();
}

this.execCommand(s.exec, key);

}, this));
}
else if (s.func !== 'show')
{
button.click($.proxy(function(e) {

this[s.func](e);

}, this));
}

if (typeof s.callback !== 'undefined' && s.callback !== false)
{
button.click($.proxy(function(e) { s.callback(this, e, key); }, this));
}

if (key === 'backcolor' || key === 'fontcolor' || typeof(s.dropdown) !== 'undefined')
{
var dropdown = $('<div class="redactor_dropdown" style="display: none;">');

if (key === 'backcolor' || key === 'fontcolor')
{
dropdown = this.buildColorPicker(dropdown, key);
}
else
{
dropdown = this.buildDropdown(dropdown, s.dropdown);
}

this.dropdowns.push(dropdown.appendTo($(document.body)));


this.hdlShowDropDown = $.proxy(function(e) { this.showDropDown(e, dropdown, key); }, this);

button.click(this.hdlShowDropDown);
}

return button;
},
buildDropdown: function(dropdown, obj)
{
$.each(obj, $.proxy(
function (x, d)
{
if (typeof(d.className) === 'undefined')
{
d.className = '';
}

var drop_a;
if (typeof d.name !== 'undefined' && d.name === 'separator')
{
drop_a = $('<a class="redactor_separator_drop">');
}
else
{
drop_a = $('<a href="javascript:void(null);" class="' + d.className + '">' + d.title + '</a>');

if (typeof(d.callback) === 'function')
{
$(drop_a).click($.proxy(function(e) { d.callback(this, e, x); }, this));
}
else if (typeof(d.func) === 'undefined')
{
$(drop_a).click($.proxy(function() { this.execCommand(d.exec, x); }, this));
}
else
{
$(drop_a).click($.proxy(function(e) { this[d.func](e); }, this));
}
}

$(dropdown).append(drop_a);

}, this)
);

return dropdown;

},
buildColorPicker: function(dropdown, key)
{
var mode;
if (key === 'backcolor')
{
if ($.browser.msie)
{
mode = 'BackColor';
}
else
{
mode = 'hilitecolor';
}
}
else
{
mode = 'forecolor';
}

$(dropdown).width(210);

var len = this.opts.colors.length;
for (var i = 0; i < len; ++i)
{
var color = this.opts.colors[i];

var swatch = $('<a rel="' + color + '" href="javascript:void(null);" class="redactor_color_link"></a>').css({ 'backgroundColor': color });
$(dropdown).append(swatch);

var _self = this;
$(swatch).click(function()
{
_self.execCommand(mode, $(this).attr('rel'));

if (mode === 'forecolor')
{
_self.$editor.find('font').replaceWith(function() {

return $('<span style="color: ' + $(this).attr('color') + ';">' + $(this).html() + '</span>');

});
}

if ($.browser.msie && mode === 'BackColor')
{
_self.$editor.find('font').replaceWith(function() {

return $('<span style="' + $(this).attr('style') + '">' + $(this).html() + '</span>');

});
}

});
}

var elnone = $('<a href="javascript:void(null);" class="redactor_color_none"></a>').html(RLANG.none);

if (key === 'backcolor')
{
elnone.click($.proxy(this.setBackgroundNone, this));
}
else
{
elnone.click($.proxy(this.setColorNone, this));
}

$(dropdown).append(elnone);

return dropdown;
},
setBackgroundNone: function()
{
$(this.getParentNode()).css('background-color', 'transparent');
this.syncCode();
},
setColorNone: function()
{
$(this.getParentNode()).attr('color', '').css('color', '');
this.syncCode();
},

showDropDown: function(e, dropdown, key)
{
if (this.getBtn(key).hasClass('dropact'))
{
this.hideAllDropDown();
}
else
{
this.hideAllDropDown();

this.setBtnActive(key);
this.getBtn(key).addClass('dropact');

var left = this.getBtn(key).offset().left;

if (this.opts.air)
{
var air_top = this.air.offset().top;

$(dropdown).css({ position: 'absolute', left: left + 'px', top: air_top+30 + 'px' }).show();
}
else if (this.opts.fixed && this.fixed)
{
$(dropdown).css({ position: 'fixed', left: left + 'px', top: '30px' }).show();
}
else
{
var top = this.$toolbar.offset().top + 30;
$(dropdown).css({ position: 'absolute', left: left + 'px', top: top + 'px' }).show();
}
}

var hdlHideDropDown = $.proxy(function(e) { this.hideDropDown(e, dropdown, key); }, this);

$(document).one('click', hdlHideDropDown);
this.$editor.one('click', hdlHideDropDown);

e.stopPropagation();

},
hideAllDropDown: function()
{
this.$toolbar.find('a.dropact').removeClass('redactor_act').removeClass('dropact');
$('.redactor_dropdown').hide();
},
hideDropDown: function(e, dropdown, key)
{
if (!$(e.target).hasClass('dropact'))
{
$(dropdown).removeClass('dropact');
this.showedDropDown = false;
this.hideAllDropDown();
}
},

getBtn: function(key)
{
if (this.opts.toolbar === false)
{
return false;
}

return $(this.$toolbar.find('a.redactor_btn_' + key));
},
setBtnActive: function(key)
{
this.getBtn(key).addClass('redactor_act');
},
setBtnInactive: function(key)
{
this.getBtn(key).removeClass('redactor_act');
},
inactiveAllButtons: function()
{
$.each(this.opts.activeButtons, $.proxy(function(i,s)
{
this.setBtnInactive(s);

}, this));
},
changeBtnIcon: function(key, classname)
{
this.getBtn(key).addClass('redactor_btn_' + classname);
},
removeBtnIcon: function(key, classname)
{
this.getBtn(key).removeClass('redactor_btn_' + classname);
},

addBtnSeparator: function()
{
this.$toolbar.append($('<li class="redactor_separator"></li>'));
},
addBtnSeparatorAfter: function(key)
{
var $btn = this.getBtn(key);
$btn.parent().after($('<li class="redactor_separator"></li>'));
},
addBtnSeparatorBefore: function(key)
{
var $btn = this.getBtn(key);
$btn.parent().before($('<li class="redactor_separator"></li>'));
},
removeBtnSeparatorAfter: function(key)
{
var $btn = this.getBtn(key);
$btn.parent().next().remove();
},
removeBtnSeparatorBefore: function(key)
{
var $btn = this.getBtn(key);
$btn.parent().prev().remove();
},

setBtnRight: function(key)
{
if (this.opts.toolbar === false)
{
return false;
}

this.getBtn(key).parent().addClass('redactor_btn_right');
},
setBtnLeft: function(key)
{
if (this.opts.toolbar === false)
{
return false;
}

this.getBtn(key).parent().removeClass('redactor_btn_right');
},
addBtn: function(key, title, callback, dropdown)
{
if (this.opts.toolbar === false)
{
return false;
}

var btn = this.buildButton(key, { title: title, callback: callback, dropdown: dropdown });
this.$toolbar.append($('<li>').append(btn));
},
addBtnFirst: function(key, title, callback, dropdown)
{
if (this.opts.toolbar === false)
{
return false;
}

var btn = this.buildButton(key, { title: title, callback: callback, dropdown: dropdown });
this.$toolbar.prepend($('<li>').append(btn));
},
addBtnAfter: function(afterkey, key, title, callback, dropdown)
{
if (this.opts.toolbar === false)
{
return false;
}

var btn = this.buildButton(key, { title: title, callback: callback, dropdown: dropdown });
var $btn = this.getBtn(afterkey);
$btn.parent().after($('<li>').append(btn));
},
addBtnBefore: function(beforekey, key, title, callback, dropdown)
{
if (this.opts.toolbar === false)
{
return false;
}

var btn = this.buildButton(key, { title: title, callback: callback, dropdown: dropdown });
var $btn = this.getBtn(beforekey);
$btn.parent().before($('<li>').append(btn));
},
removeBtn: function(key, separator)
{
var $btn = this.getBtn(key);

if (separator === true)
{
$btn.parent().next().remove();
}

$btn.parent().removeClass('redactor_btn_right');
$btn.remove();
},


getSelection: function ()
{
if (typeof window.getSelection !== 'undefined')
{
return document.getSelection();
}
else if (typeof document.selection !== 'undefined')
{
return document.selection.createRange();
}
},
getFragmentHtml: function (fragment)
{
var cloned = fragment.cloneNode(true);
var div = document.createElement('div');
div.appendChild(cloned);
return div.innerHTML;
},
extractContent: function()
{
var node = this.$editor.get(0);
var frag = document.createDocumentFragment(), child;
while ((child = node.firstChild))
{
frag.appendChild(child);
}

return frag;
},
saveSelection: function()
{
this.$editor.focus();
this.savedSel = null;
this.savedSelObj = null;

if ($.browser.msie && parseInt($.browser.version, 10) < 9)
{
var node = this.$editor.get(0);
this.savedSel = window.Selection.getOrigin(node);
this.savedSelObj = window.Selection.getFocus(node);
}
else
{
this.savedSel = window.Selection.getOrigin(window);
this.savedSelObj = window.Selection.getFocus(window);
}
},
restoreSelection: function()
{
if (typeof this.savedSel !== 'undefined' && this.savedSel !== null && this.savedSelObj !== null && this.savedSel[0].tagName !== 'BODY')
{
if ($(this.savedSel[0]).closest('.redactor_editor').size() == 0)
{
this.$editor.focus();
}
else
{
window.Selection.setSelection(window, this.savedSel[0], this.savedSel[1], this.savedSelObj[0], this.savedSelObj[1]);
}
}
else
{
this.$editor.focus();
}
},
getParentNode: function()
{
if (typeof window.getSelection !== 'undefined')
{
var s = window.getSelection();
if (s.rangeCount > 0)
{
return this.getSelection().getRangeAt(0).startContainer.parentNode;
}
else return false;

}
else if (typeof document.selection !== 'undefined')
{
return this.getSelection().parentElement();
}
},
getCurrentNode: function()
{
if (typeof window.getSelection !== 'undefined')
{
var s = window.getSelection();
if (s.rangeCount > 0)
{
return this.getSelection().getRangeAt(0).startContainer;
}
else
{
return false;
}
}
else if (typeof document.selection !== 'undefined')
{
return this.getSelection();
}
},
setFocusNode: function(node)
{
if (typeof node === 'undefined')
{
return false;
}

try {

var range = document.createRange();
var selection = this.getSelection();

if (selection !== null)
{
range.selectNodeContents(node);
selection.addRange(range);
selection.collapse(node, 0);
}

this.$editor.focus();

} catch (e) { }

},

insertNodeAfterCaret: function(node)
{
this.saveSelection();
this.insertNodeAtCaret(node);
this.restoreSelection();
},

insertNodeAtCaret: function(node)
{
if (window.getSelection)
{
var sel = this.getSelection();
if (sel.rangeCount)
{
var range = sel.getRangeAt(0);
range.collapse(false);
range.insertNode(node);
range = range.cloneRange();
range.selectNodeContents(node);
range.collapse(false);
sel.removeAllRanges();
sel.addRange(range);
}
}
else if (document.selection)
{
var html = (node.nodeType === 1) ? node.outerHTML : node.data;
var id = "marker_" + ("" + Math.random()).slice(2);
html += '<span id="' + id + '"></span>';
var textRange = this.getSelection();
textRange.collapse(false);
textRange.pasteHTML(html);
var markerSpan = document.getElementById(id);
textRange.moveToElementText(markerSpan);
textRange.select();
markerSpan.parentNode.removeChild(markerSpan);
}
},
getSelectedHtml: function()
{
var html = '';
if (window.getSelection)
{
var sel = window.getSelection();
if (sel.rangeCount)
{
var container = document.createElement("div");
for (var i = 0, len = sel.rangeCount; i < len; ++i)
{
container.appendChild(sel.getRangeAt(i).cloneContents());
}

html = container.innerHTML;

}
}
else if (document.selection)
{
if (document.selection.type === "Text")
{
html = document.selection.createRange().htmlText;
}
}

return html;
},


resizeImage: function(resize)
{
var clicked = false;
var clicker = false;
var start_x;
var start_y;
var ratio = $(resize).width()/$(resize).height();
var min_w = 10;
var min_h = 10;

$(resize).off('hover mousedown mouseup click mousemove');
$(resize).hover(function() { $(resize).css('cursor', 'nw-resize'); }, function() { $(resize).css('cursor',''); clicked = false; });

$(resize).mousedown(function(e)
{
e.preventDefault();

ratio = $(resize).width()/$(resize).height();

clicked = true;
clicker = true;

start_x = Math.round(e.pageX - $(resize).eq(0).offset().left);
start_y = Math.round(e.pageY - $(resize).eq(0).offset().top);
});

$(resize).mouseup($.proxy(function(e)
{
clicked = false;
this.syncCode();

}, this));

$(resize).click($.proxy(function(e)
{
if (clicker)
{
this.imageEdit(e);
}

}, this));

$(resize).mousemove(function(e)
{
if (clicked)
{
clicker = false;

var mouse_x = Math.round(e.pageX - $(this).eq(0).offset().left) - start_x;
var mouse_y = Math.round(e.pageY - $(this).eq(0).offset().top) - start_y;

var div_h = $(resize).height();

var new_h = parseInt(div_h, 10) + mouse_y;
var new_w = new_h*ratio;

if (new_w > min_w)
{
$(resize).width(new_w);
}

if (new_h > min_h)
{
$(resize).height(new_h);
}

start_x = Math.round(e.pageX - $(this).eq(0).offset().left);
start_y = Math.round(e.pageY - $(this).eq(0).offset().top);
}
});
},


showTable: function()
{
this.saveSelection();

this.modalInit(RLANG.table, this.opts.modal_table, 300, $.proxy(function()
{
$('#redactor_insert_table_btn').click($.proxy(this.insertTable, this));
$('#redactor_table_rows').focus();

}, this)
);
},
insertTable: function()
{
var rows = $('#redactor_table_rows').val();
var columns = $('#redactor_table_columns').val();

var table_box = $('<div></div>');

var tableid = Math.floor(Math.random() * 99999);
var table = $('<table id="table' + tableid + '"><tbody></tbody></table>');

for (var i = 0; i < rows; i++)
{
var row = $('<tr></tr>');
for (var z = 0; z < columns; z++)
{
var column = $('<td><br></td>');
$(row).append(column);
}
$(table).append(row);
}

$(table_box).append(table);
var html = $(table_box).html() + '<p></p>';

this.restoreSelection();
this.execCommand('inserthtml', html);
this.modalClose();
this.observeTables();

},
tableObserver: function(e)
{
this.$table = $(e.target).closest('table');

this.$table_tr = this.$table.find('tr');
this.$table_td = this.$table.find('td');

this.$tbody = $(e.target).closest('tbody');
this.$thead = $(this.$table).find('thead');

this.$current_td = $(e.target);
this.$current_tr = $(e.target).closest('tr');
},
deleteTable: function()
{
$(this.$table).remove();
this.$table = false;
this.syncCode();
},
deleteRow: function()
{
$(this.$current_tr).remove();
this.syncCode();
},
deleteColumn: function()
{
var index = $(this.$current_td).get(0).cellIndex;

$(this.$table).find('tr').each(function()
{
$(this).find('td').eq(index).remove();
});

this.syncCode();
},
addHead: function()
{
if ($(this.$table).find('thead').size() !== 0)
{
this.deleteHead();
}
else
{
var tr = $(this.$table).find('tr').first().clone();
tr.find('td').html('&nbsp;');
this.$thead = $('<thead></thead>');
this.$thead.append(tr);
$(this.$table).prepend(this.$thead);
this.syncCode();
}
},
deleteHead: function()
{
$(this.$thead).remove();
this.$thead = false;
this.syncCode();
},
insertRowAbove: function()
{
this.insertRow('before');
},
insertRowBelow: function()
{
this.insertRow('after');
},
insertColumnLeft: function()
{
this.insertColumn('before');
},
insertColumnRight: function()
{
this.insertColumn('after');
},
insertRow: function(type)
{
var new_tr = $(this.$current_tr).clone();
new_tr.find('td').html('&nbsp;');
if (type === 'after')
{
$(this.$current_tr).after(new_tr);
}
else
{
$(this.$current_tr).before(new_tr);
}

this.syncCode();
},
insertColumn: function(type)
{
var index = 0;

this.$current_tr.find('td').each($.proxy(function(i,s)
{
if ($(s)[0] === this.$current_td[0])
{
index = i;
}
}, this));

this.$table_tr.each(function(i,s)
{
var current = $(s).find('td').eq(index);

var td = current.clone();
td.html('&nbsp;');

if (type === 'after')
{
$(current).after(td);
}
else
{
$(current).before(td);
}

});

this.syncCode();
},


showVideo: function()
{
this.saveSelection();
this.modalInit(RLANG.video, this.opts.modal_video, 600, $.proxy(function()
{
$('#redactor_insert_video_btn').click($.proxy(this.insertVideo, this));
$('#redactor_insert_video_area').focus();

}, this)
);
},
insertVideo: function()
{
var data = $('#redactor_insert_video_area').val();
data = this.stripTags(data);

this.restoreSelection();
this.execCommand('inserthtml', data);
this.modalClose();
},


imageEdit: function(e)
{
var $el = $(e.target);
var parent = $el.parent();

var callback = $.proxy(function()
{
$('#redactor_file_alt').val($el.attr('alt'));
$('#redactor_image_edit_src').attr('href', $el.attr('src'));
$('#redactor_form_image_align').val($el.css('float'));

if ($(parent).get(0).tagName === 'A')
{
$('#redactor_file_link').val($(parent).attr('href'));
}

$('#redactor_image_delete_btn').click($.proxy(function() { this.imageDelete($el); }, this));
$('#redactorSaveBtn').click($.proxy(function() { this.imageSave($el); }, this));

}, this);

this.modalInit(RLANG.image, this.opts.modal_image_edit, 380, callback);

},
imageDelete: function(el)
{
$(el).remove();
this.modalClose();
this.syncCode();
},
imageSave: function(el)
{
var parent = $(el).parent();

$(el).attr('alt', $('#redactor_file_alt').val());

var floating = $('#redactor_form_image_align').val();

if (floating === 'left')
{
$(el).css({ 'float': 'left', margin: '0 10px 10px 0' });
}
else if (floating === 'right')
{
$(el).css({ 'float': 'right', margin: '0 0 10px 10px' });
}
else
{
$(el).css({ 'float': 'none', margin: '0' });
}


var link = $.trim($('#redactor_file_link').val());
if (link !== '')
{
if ($(parent).get(0).tagName !== 'A')
{
$(el).replaceWith('<a href="' + link + '">' + this.outerHTML(el) + '</a>');
}
else
{
$(parent).attr('href', link);
}
}
else
{
if ($(parent).get(0).tagName === 'A')
{
$(parent).replaceWith(this.outerHTML(el));
}
}

this.modalClose();
this.observeImages();
this.syncCode();

},
showImage: function()
{
this.saveSelection();

var callback = $.proxy(function()
{

if (this.opts.imageGetJson !== false)
{
$.getJSON(this.opts.imageGetJson, $.proxy(function(data) {

var folders = {};
var z = 0;


$.each(data, $.proxy(function(key, val)
{
if (typeof val.folder !== 'undefined')
{
z++;
folders[val.folder] = z;
}

}, this));

var folderclass = false;
$.each(data, $.proxy(function(key, val)
{

var thumbtitle = '';
if (typeof val.title !== 'undefined')
{
thumbtitle = val.title;
}

var folderkey = 0;
if (!$.isEmptyObject(folders) && typeof val.folder !== 'undefined')
{
folderkey = folders[val.folder];
if (folderclass === false)
{
folderclass = '.redactorfolder' + folderkey;
}
}

var img = $('<img src="' + val.thumb + '" class="redactorfolder redactorfolder' + folderkey + '" rel="' + val.image + '" title="' + thumbtitle + '" />');
$('#redactor_image_box').append(img);
$(img).click($.proxy(this.imageSetThumb, this));


}, this));


if (!$.isEmptyObject(folders))
{
$('.redactorfolder').hide();
$(folderclass).show();

var onchangeFunc = function(e)
{
$('.redactorfolder').hide();
$('.redactorfolder' + $(e.target).val()).show();
}

var select = $('<select id="redactor_image_box_select">');
$.each(folders, function(k,v)
{
select.append($('<option value="' + v + '">' + k + '</option>'));
});

$('#redactor_image_box').before(select);
select.change(onchangeFunc);
}

}, this));
}
else
{
$('#redactor_tabs a').eq(1).remove();
}

if (this.opts.imageUpload !== false)
{


if (this.opts.uploadCrossDomain === false && this.isMobile() === false)
{

if ($('#redactor_file').size() !== 0)
{
$('#redactor_file').dragupload(
{
url: this.opts.imageUpload,
uploadFields: this.opts.uploadFields,
success: $.proxy(this.imageUploadCallback, this),
error: $.proxy(this.opts.imageUploadErrorCallback, this)
});
}
}


this.uploadInit('redactor_file',
{
auto: true,
url: this.opts.imageUpload,
success: $.proxy(this.imageUploadCallback, this),
error: $.proxy(this.opts.imageUploadErrorCallback, this)
});
}
else
{
$('.redactor_tab').hide();
if (this.opts.imageGetJson === false)
{
$('#redactor_tabs').remove();
$('#redactor_tab3').show();
}
else
{
var tabs = $('#redactor_tabs a');
tabs.eq(0).remove();
tabs.eq(1).addClass('redactor_tabs_act');
$('#redactor_tab2').show();
}
}

$('#redactor_upload_btn').click($.proxy(this.imageUploadCallbackLink, this));

if (this.opts.imageUpload === false && this.opts.imageGetJson === false)
{
$('#redactor_file_link').focus();
}

}, this);

this.modalInit(RLANG.image, this.opts.modal_image, 610, callback);

},
imageSetThumb: function(e)
{
this._imageSet('<img src="' + $(e.target).attr('rel') + '" alt="' + $(e.target).attr('title') + '" />', true);
},
imageUploadCallbackLink: function()
{
if ($('#redactor_file_link').val() !== '')
{
var data = '<img src="' + $('#redactor_file_link').val() + '" />';
this._imageSet(data, true);
}
else
{
this.modalClose();
}
},
imageUploadCallback: function(data)
{
this._imageSet(data);
},
_imageSet: function(json, link)
{
this.restoreSelection();

if (json !== false)
{
var html = '';
if (link !== true)
{
html = '<p><img src="' + json.filelink + '" /></p>';
}
else
{
html = json;
}

this.execCommand('inserthtml', html);


if (link !== true && typeof this.opts.imageUploadCallback === 'function')
{
this.opts.imageUploadCallback(this, json);
}
}

this.modalClose();
this.observeImages();
},


showLink: function()
{
this.saveSelection();

var callback = $.proxy(function()
{
this.insert_link_node = false;
var sel = this.getSelection();
var url = '', text = '', target = '';

if ($.browser.msie)
{
var parent = this.getParentNode();
if (parent.nodeName === 'A')
{
this.insert_link_node = $(parent);
text = this.insert_link_node.text();
url = this.insert_link_node.attr('href');
target = this.insert_link_node.attr('target');
}
else
{
if (this.oldIE())
{
text = sel.text;
}
else
{
text = sel.toString();
}
}
}
else
{
if (sel && sel.anchorNode && sel.anchorNode.parentNode.tagName === 'A')
{
url = sel.anchorNode.parentNode.href;
text = sel.anchorNode.parentNode.text;
target = sel.anchorNode.parentNode.target;

if (sel.toString() === '')
{
this.insert_link_node = sel.anchorNode.parentNode;
}
}
else
{
text = sel.toString();
}
}

$('.redactor_link_text').val(text);

var thref = self.location.href.replace(/\/$/i, '');
var turl = url.replace(thref, '');

if (url.search('mailto:') === 0)
{
this.setModalTab(2);

$('#redactor_tab_selected').val(2);
$('#redactor_link_mailto').val(url.replace('mailto:', ''));
}
else if (turl.search(/^#/gi) === 0)
{
this.setModalTab(3);

$('#redactor_tab_selected').val(3);
$('#redactor_link_anchor').val(turl.replace(/^#/gi, ''));
}
else
{
$('#redactor_link_url').val(turl);
}

if (target === '_blank')
{
$('#redactor_link_blank').attr('checked', true);
}

$('#redactor_insert_link_btn').click($.proxy(this.insertLink, this));

$('#redactor_link_url').focus();

}, this);

this.modalInit(RLANG.link, this.opts.modal_link, 460, callback);

},
insertLink: function()
{
var tab_selected = $('#redactor_tab_selected').val();
var link = '', text = '', target = '';

if (tab_selected === '1')
{
link = $('#redactor_link_url').val();
text = $('#redactor_link_url_text').val();

if ($('#redactor_link_blank').attr('checked'))
{
target = ' target="_blank"';
}


var pattern = '((xn--)?[a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]{2,}';
var re = new RegExp('^(http|ftp|https)://' + pattern,'i');
var re2 = new RegExp('^' + pattern,'i');
if (link.search(re) == -1 && link.search(re2) == 0 && this.opts.protocol !== false)
{
link = this.opts.protocol + link;
}
}
else if (tab_selected === '2')
{
link = 'mailto:' + $('#redactor_link_mailto').val();
text = $('#redactor_link_mailto_text').val();
}
else if (tab_selected === '3')
{
link = '#' + $('#redactor_link_anchor').val();
text = $('#redactor_link_anchor_text').val();
}

this._insertLink('<a href="' + link + '"' + target + '>' +  text + '</a>', $.trim(text), link, target);

},
_insertLink: function(a, text, link, target)
{
this.$editor.focus();
this.restoreSelection();

if (text !== '')
{
if (this.insert_link_node)
{
$(this.insert_link_node).text(text);
$(this.insert_link_node).attr('href', link);
if (target !== '')
{
$(this.insert_link_node).attr('target', target);
}
else
{
$(this.insert_link_node).removeAttr('target');
}

this.syncCode();
}
else
{
this.execCommand('inserthtml', a);
}
}

this.modalClose();
},


showFile: function()
{
this.saveSelection();

var callback = $.proxy(function()
{
var sel = this.getSelection();

var text = '';

if (this.oldIE())
{
text = sel.text;
}
else
{
text = sel.toString();
}

$('#redactor_filename').val(text);


if (this.opts.uploadCrossDomain === false && this.isMobile() === false)
{
$('#redactor_file').dragupload(
{
url: this.opts.fileUpload,
uploadFields: this.opts.uploadFields,
success: $.proxy(this.fileUploadCallback, this),
error: $.proxy(this.opts.fileUploadErrorCallback, this)
});
}

this.uploadInit('redactor_file',
{
auto: true,
url: this.opts.fileUpload,
success: $.proxy(this.fileUploadCallback, this),
error: $.proxy(this.opts.fileUploadErrorCallback, this)
});

}, this);

this.modalInit(RLANG.file, this.opts.modal_file, 500, callback);
},
fileUploadCallback: function(json)
{
this.restoreSelection();

if (json !== false)
{
var text = $('#redactor_filename').val();

if (text === '')
{
text = json.filename;
}

var link = '<a href="' + json.filelink + '">' + text + '</a>';


if ($.browser.webkit && !!window.chrome)
{
link = link + '&nbsp;';
}

this.execCommand('inserthtml', link);


if (typeof this.opts.fileUploadCallback === 'function')
{
this.opts.fileUploadCallback(this, json);
}
}

this.modalClose();
},




modalInit: function(title, content, width, callback)
{

if ($('#redactor_modal_overlay').size() === 0)
{
this.overlay = $('<div id="redactor_modal_overlay" style="display: none;"></div>');
$('body').prepend(this.overlay);
}

if (this.opts.overlay)
{
$('#redactor_modal_overlay').show();
$('#redactor_modal_overlay').click($.proxy(this.modalClose, this));
}

if ($('#redactor_modal').size() === 0)
{
this.modal = $('<div id="redactor_modal" style="display: none;"><div id="redactor_modal_close">&times;</div><div id="redactor_modal_header"></div><div id="redactor_modal_inner"></div></div>');
$('body').append(this.modal);
}

$('#redactor_modal_close').click($.proxy(this.modalClose, this));

this.hdlModalClose = $.proxy(function(e) { if ( e.keyCode === 27) { this.modalClose(); return false; } }, this);

$(document).keyup(this.hdlModalClose);
this.$editor.keyup(this.hdlModalClose);


if (content.indexOf('#') == 0)
{
$('#redactor_modal_inner').empty().append($(content).html());
}
else
{
$('#redactor_modal_inner').empty().append(content);
}


$('#redactor_modal_header').html(title);


if (typeof $.fn.draggable !== 'undefined')
{
$('#redactor_modal').draggable({ handle: '#redactor_modal_header' });
$('#redactor_modal_header').css('cursor', 'move');
}


if ($('#redactor_tabs').size() !== 0)
{
var that = this;
$('#redactor_tabs a').each(function(i,s)
{
i++;
$(s).click(function()
{
$('#redactor_tabs a').removeClass('redactor_tabs_act');
$(this).addClass('redactor_tabs_act');
$('.redactor_tab').hide();
$('#redactor_tab' + i).show();
$('#redactor_tab_selected').val(i);

if (that.isMobile() === false)
{
var height = $('#redactor_modal').outerHeight();
$('#redactor_modal').css('margin-top', '-' + (height+10)/2 + 'px');
}
});
});
}



$('#redactor_modal .redactor_btn_modal_close').click($.proxy(this.modalClose, this));

if (this.isMobile() === false)
{
$('#redactor_modal').css({ position: 'fixed', top: '-2000px', left: '50%', width: width + 'px', marginLeft: '-' + (width+60)/2 + 'px' }).show();

this.modalSaveBodyOveflow = $(document.body).css('overflow');
$(document.body).css('overflow', 'hidden');
}
else
{
$('#redactor_modal').css({ position: 'fixed', width: '100%', height: '100%', top: '0', left: '0', margin: '0', minHeight: '300px' }).show();
}


if (typeof callback === 'function')
{
callback();
}

if (this.isMobile() === false)
{
setTimeout(function()
{
var height = $('#redactor_modal').outerHeight();
$('#redactor_modal').css({ top: '50%', height: 'auto', minHeight: 'auto', marginTop: '-' + (height+10)/2 + 'px' });

}, 20);
}

},
modalClose: function()
{
$('#redactor_modal_close').unbind('click', this.modalClose);
$('#redactor_modal').fadeOut('fast', $.proxy(function()
{
$('#redactor_modal_inner').html('');

if (this.opts.overlay)
{
$('#redactor_modal_overlay').hide();
$('#redactor_modal_overlay').unbind('click', this.modalClose);
}

$(document).unbind('keyup', this.hdlModalClose);
this.$editor.unbind('keyup', this.hdlModalClose);

}, this));


if (this.isMobile() === false)
{
$(document.body).css('overflow', this.modalSaveBodyOveflow ? this.modalSaveBodyOveflow : 'visible');
}

return false;

},
setModalTab: function(num)
{
$('.redactor_tab').hide();
var tabs = $('#redactor_tabs a');
tabs.removeClass('redactor_tabs_act');
tabs.eq(num-1).addClass('redactor_tabs_act');
$('#redactor_tab' + num).show();
},


uploadInit: function(element, options)
{

this.uploadOptions = {
url: false,
success: false,
error: false,
start: false,
trigger: false,
auto: false,
input: false
};

$.extend(this.uploadOptions, options);


if ($('#' + element).size() !== 0 && $('#' + element).get(0).tagName === 'INPUT')
{
this.uploadOptions.input = $('#' + element);
this.element = $($('#' + element).get(0).form);
}
else
{
this.element = $('#' + element);
}

this.element_action = this.element.attr('action');


if (this.uploadOptions.auto)
{
$(this.uploadOptions.input).change($.proxy(function()
{
this.element.submit(function(e) { return false; });
this.uploadSubmit();
}, this));

}
else if (this.uploadOptions.trigger)
{
$('#' + this.uploadOptions.trigger).click($.proxy(this.uploadSubmit, this));
}
},
uploadSubmit : function()
{
this.uploadForm(this.element, this.uploadFrame());
},
uploadFrame : function()
{
this.id = 'f' + Math.floor(Math.random() * 99999);

var d = document.createElement('div');
var iframe = '<iframe style="display:none" id="'+this.id+'" name="'+this.id+'"></iframe>';
d.innerHTML = iframe;
document.body.appendChild(d);


if (this.uploadOptions.start)
{
this.uploadOptions.start();
}

$('#' + this.id).load($.proxy(this.uploadLoaded, this));

return this.id;
},
uploadForm : function(f, name)
{
if (this.uploadOptions.input)
{
var formId = 'redactorUploadForm' + this.id;
var fileId = 'redactorUploadFile' + this.id;
this.form = $('<form  action="' + this.uploadOptions.url + '" method="POST" target="' + name + '" name="' + formId + '" id="' + formId + '" enctype="multipart/form-data"></form>');


if (this.opts.uploadFields !== false && typeof this.opts.uploadFields === 'object')
{
$.each(this.opts.uploadFields, $.proxy(function(k,v)
{
if (v.toString().indexOf('#') === 0)
{
v = $(v).val();
}

var hidden = $('<input type="hidden" name="' + k + '" value="' + v + '">');
$(this.form).append(hidden);

}, this));
}

var oldElement = this.uploadOptions.input;
var newElement = $(oldElement).clone();
$(oldElement).attr('id', fileId);
$(oldElement).before(newElement);
$(oldElement).appendTo(this.form);
$(this.form).css('position', 'absolute');
$(this.form).css('top', '-2000px');
$(this.form).css('left', '-2000px');
$(this.form).appendTo('body');

this.form.submit();
}
else
{
f.attr('target', name);
f.attr('method', 'POST');
f.attr('enctype', 'multipart/form-data');
f.attr('action', this.uploadOptions.url);

this.element.submit();
}

},
uploadLoaded : function()
{
var i = $('#' + this.id);
var d;

if (i.contentDocument)
{
d = i.contentDocument;
}
else if (i.contentWindow)
{
d = i.contentWindow.document;
}
else
{
d = window.frames[this.id].document;
}

if (this.uploadOptions.success)
{
if (typeof d !== 'undefined')
{

var rawString = d.body.innerHTML;
var jsonString = rawString.match(/\{(.|\n)*\}/)[0];
var json = $.parseJSON(jsonString);

if (typeof json.error == 'undefined')
{
this.uploadOptions.success(json);
}
else
{
this.uploadOptions.error(this, json);
this.modalClose();
}
}
else
{
alert('Upload failed!');
this.modalClose();
}
}

this.element.attr('action', this.element_action);
this.element.attr('target', '');

},


oldIE: function()
{
if ($.browser.msie && parseInt($.browser.version, 10) < 9)
{
return true;
}

return false;
},
outerHTML: function(s)
{
return $("<p>").append($(s).eq(0).clone()).html();
},
normalize: function(str)
{
return parseInt(str.replace('px',''), 10);
},
isMobile: function(ipad)
{
if (ipad === true && /(iPhone|iPod|iPad|BlackBerry|Android)/.test(navigator.userAgent))
{
return true;
}
else if (/(iPhone|iPod|BlackBerry|Android)/.test(navigator.userAgent))
{
return true;
}
else
{
return false;
}
}

};



$.fn.getObject = function()
{
return this.data('redactor');
};

$.fn.getEditor = function()
{
return this.data('redactor').$editor;
};

$.fn.getCode = function()
{
return $.trim(this.data('redactor').getCode());
};

$.fn.getText = function()
{
return this.data('redactor').$editor.text();
};

$.fn.getSelected = function()
{
return this.data('redactor').getSelectedHtml();
};

$.fn.setCode = function(html)
{
this.data('redactor').setCode(html);
};

$.fn.insertHtml = function(html)
{
this.data('redactor').insertHtml(html);
};

$.fn.destroyEditor = function()
{
this.each(function()
{
if (typeof $(this).data('redactor') != 'undefined')
{
$(this).data('redactor').destroy();
$(this).removeData('redactor');
}
});
};

$.fn.setFocus = function()
{
this.data('redactor').$editor.focus();
};

$.fn.execCommand = function(cmd, param)
{
this.data('redactor').execCommand(cmd, param);
};

})(jQuery);


(function($){

"use strict";


$.fn.dragupload = function(options)
{
return this.each(function() {
var obj = new Construct(this, options);
obj.init();
});
};


function Construct(el, options) {

this.opts = $.extend({

url: false,
success: false,
error: false,
preview: false,
uploadFields: false,

text: RLANG.drop_file_here,
atext: RLANG.or_choose

}, options);

this.$el = $(el);
}


Construct.prototype = {
init: function()
{
if (!$.browser.msie)
{
this.droparea = $('<div class="redactor_droparea"></div>');
this.dropareabox = $('<div class="redactor_dropareabox">' + this.opts.text + '</div>');
this.dropalternative = $('<div class="redactor_dropalternative">' + this.opts.atext + '</div>');

this.droparea.append(this.dropareabox);

this.$el.before(this.droparea);
this.$el.before(this.dropalternative);

this.dropareabox.bind('dragover', $.proxy(function() { return this.ondrag(); }, this));


this.dropareabox.bind('dragleave', $.proxy(function() { return this.ondragleave(); }, this));

var uploadProgress = $.proxy(function(e)
{
var percent = parseInt(e.loaded / e.total * 100, 10);
this.dropareabox.text('Loading ' + percent + '%');

}, this);

var xhr = jQuery.ajaxSettings.xhr();

if (xhr.upload)
{
xhr.upload.addEventListener('progress', uploadProgress, false);
}

var provider = function () { return xhr; };

this.dropareabox.get(0).ondrop = $.proxy(function(event)
{
event.preventDefault();

this.dropareabox.removeClass('hover').addClass('drop');

var file = event.dataTransfer.files[0];
var fd = new FormData();

if (this.opts.uploadFields !== false && typeof this.opts.uploadFields === 'object')
{
$.each(this.opts.uploadFields, $.proxy(function(k,v)
{
if (v.toString().indexOf('#') === 0)
{
v = $(v).val();
}

fd.append(k, v);

}, this));
}

fd.append('file', file);

$.ajax({
url: this.opts.url,
dataType: 'html',
data: fd,
xhr: provider,
cache: false,
contentType: false,
processData: false,
type: 'POST',
success: $.proxy(function(data)
{
var json = $.parseJSON(data);

if (typeof json.error == 'undefined')
{
this.opts.success(json);
}
else
{
this.opts.error(this, json);
this.opts.success(false);
}

}, this)
});


}, this);
}
},
ondrag: function()
{
this.dropareabox.addClass('hover');
return false;
},
ondragleave: function()
{
this.dropareabox.removeClass('hover');
return false;
}
};

})(jQuery);



(function($){

"use strict";

var protocol = 'http://';
var url1 = /(^|&lt;|\s)(www\..+?\..+?)(\s|&gt;|$)/g,
url2 = /(^|&lt;|\s)(((https?|ftp):\/\/|mailto:).+?)(\s|&gt;|$)/g,

linkifyThis = function ()
{
var childNodes = this.childNodes,
i = childNodes.length;
while(i--)
{
var n = childNodes[i];
if (n.nodeType === 3)
{
var html = n.nodeValue;
if (html)
{
html = html.replace(/&/g, '&amp;')
.replace(/</g, '&lt;')
.replace(/>/g, '&gt;')
.replace(url1, '$1<a href="' + protocol + '$2">$2</a>$3')
.replace(url2, '$1<a href="$2">$2</a>$5');

$(n).after(html).remove();
}
}
else if (n.nodeType === 1  &&  !/^(a|button|textarea)$/i.test(n.tagName))
{
linkifyThis.call(n);
}
}
};

$.fn.linkify = function ()
{
this.each(linkifyThis);
};

})(jQuery);


(function($){$.event.special.textselect={setup:function(data,namespaces){$(this).data("textselected",false);$(this).data("ttt",data);$(this).bind('mouseup',$.event.special.textselect.handler)},teardown:function(data){$(this).unbind('mouseup',$.event.special.textselect.handler)},handler:function(event){var data=$(this).data("ttt");var text=$.event.special.textselect.getSelectedText(data).toString();if(text!=''){$(this).data("textselected",true);event.type="textselect";event.text=text;$.event.handle.apply(this,arguments)}},getSelectedText:function(data){var text='';if(window.getSelection)text=window.getSelection();else if(document.getSelection) text=document.getSelection();else if(document.selection)text=document.selection.createRange().text;return text}};$.event.special.textunselect={setup:function(data,namespaces){$(this).data("rttt",data);$(this).data("textselected",false);$(this).bind('mouseup',$.event.special.textunselect.handler);$(this).bind('keyup',$.event.special.textunselect.handlerKey)},teardown:function(data){$(this).unbind('mouseup',$.event.special.textunselect.handler)},handler:function(event){if($(this).data("textselected")){var data=$(this).data("rttt");var text=$.event.special.textselect.getSelectedText(data).toString();if(text==''){$(this).data("textselected",false);event.type="textunselect";$.event.handle.apply(this,arguments)}}},handlerKey:function(event){if($(this).data("textselected")){var data=$(this).data("rttt");var text=$.event.special.textselect.getSelectedText(data).toString();if((event.keyCode=27)&&(text=='')){$(this).data("textselected",false);event.type="textunselect";$.event.handle.apply(this,arguments)}}}}})(jQuery);





/* 
 * Author: @senthil2rajan
 * plugin: timepicker
 * website: senthilraj.github.io/Timepicki
 */
(function($) {

	$.fn.timepicki = function(options) {

		var defaults = {
			format_output: function(tim, mini, meri) {
				if(settings.show_meridian){
					return tim + " : " + mini + " : " + meri;
				}else{
					return tim + " : " + mini;
				}
			},
			increase_direction: 'down',
			custom_classes: '',
			min_hour_value: 1,
			max_hour_value: 12,
			show_meridian: true,
			step_size_hours: '1',
			step_size_minutes: '1',
			overflow_minutes: false,
			disable_keyboard_mobile: false,
			reset: false,
			on_change: null
		};

		var settings = $.extend({}, defaults, options);

		return this.each(function() {

			var ele = $(this);
			var ele_hei = ele.outerHeight();
			ele_hei += 10;
			$(ele).wrap("<div class='time_pick'>");
			var ele_par = $(this).parents(".time_pick");

			// developer can specify which arrow makes the numbers go up or down
			var top_arrow_button = (settings.increase_direction === 'down') ?
				"<div class='prev action-prev'></div>" :
				"<div class='prev action-next'></div>";
			var bottom_arrow_button = (settings.increase_direction === 'down') ?
				"<div class='next action-next'></div>" :
				"<div class='next action-prev'></div>";

			var new_ele = $(
				"<div class='timepicker_wrap " + settings.custom_classes + "'>" +
					"<div class='arrow_top'></div>" +
					"<div class='time'>" +
						top_arrow_button +
						"<div class='ti_tx'><input type='text' class='timepicki-input'" + (settings.disable_keyboard_mobile ? "readonly" : "") + "></div>" +
						bottom_arrow_button +
					"</div>" +
					"<div class='mins'>" +
						top_arrow_button +
						"<div class='mi_tx'><input type='text' class='timepicki-input'" + (settings.disable_keyboard_mobile ? "readonly" : "") + "></div>" +
						bottom_arrow_button +
					"</div>");
			if(settings.show_meridian){
				new_ele.append(
					"<div class='meridian'>" +
						top_arrow_button +
						"<div class='mer_tx'><input type='text' class='timepicki-input' readonly></div>" +
						bottom_arrow_button +
					"</div>");
			}
			if(settings.reset){
				new_ele.append(
					"<div><a href='#' class='reset_time'>Reset</a></div>");
			}
			ele_par.append(new_ele);
			var ele_next = $(this).next(".timepicker_wrap");
			var ele_next_all_child = ele_next.find("div");
			var inputs = ele_par.find('input');
			
			$('.reset_time').on("click", function(event) {
				ele.val("");
				close_timepicki();
			});		
			$(".timepicki-input").keydown( function(keyevent){
					var len = $(this).val().length;

					// Allow: backspace, delete, tab, escape, enter and .
					if ($.inArray(keyevent.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
					     // Allow: Ctrl+A
					    (keyevent.keyCode == 65 && keyevent.ctrlKey === true) || 
					     // Allow: home, end, left, right
					    (keyevent.keyCode >= 35 && keyevent.keyCode <= 39)) {
						 // let it happen, don't do anything
						 return;
					}
					// Ensure that it is a number and stop the keypress
					if ((keyevent.shiftKey || (keyevent.keyCode < 48 || keyevent.keyCode > 57)) && 
					(keyevent.keyCode < 96 || keyevent.keyCode > 105) || len==2 ) {
					    keyevent.preventDefault();
					}

			});

			// open or close time picker when clicking
			$(document).on("click", function(event) {
				if (!$(event.target).is(ele_next) && ele_next.css("display")=="block" && !$(event.target).is($('.reset_time'))) {
					if (!$(event.target).is(ele)) {
						set_value(event, !is_element_in_timepicki($(event.target)));
					} else {
						var ele_lef =  0;
						
						ele_next.css({
							"top": ele_hei + "px",
							"left": ele_lef + "px"
						});
						open_timepicki();
					}
				}
			});

			// open the modal when the user focuses on the input
			ele.on('focus', open_timepicki);

			// select all text in input when user focuses on it
			inputs.on('focus', function() {
				var input = $(this);
				if (!input.is(ele)) {
					input.select();
				}
			});

			// allow user to increase and decrease numbers using arrow keys
			inputs.on('keydown', function(e) {
				var direction, input = $(this);

				// UP
				if (e.which === 38) {
					if (settings.increase_direction === 'down') {
						direction = 'prev';
					} else {
						direction = 'next';
					}
				// DOWN
				} else if (e.which === 40) {
					if (settings.increase_direction === 'down') {
						direction = 'next';
					} else {
						direction = 'prev';
					}
				}

				if (input.closest('.timepicker_wrap .time').length) {
					change_time(null, direction);
				} else if (input.closest('.timepicker_wrap .mins').length) {
					change_mins(null, direction);
				} else if (input.closest('.timepicker_wrap .meridian').length && settings.show_meridian) {
					change_meri(null, direction);
				}
			});

			// close the modal when the time picker loses keyboard focus
			inputs.on('blur', function() {
				setTimeout(function() {
					var focused_element = $(document.activeElement);
					if (focused_element.is(':input') && !is_element_in_timepicki(focused_element)) {
						set_value();
						close_timepicki();
					}
				}, 0);
			});

			function is_element_in_timepicki(jquery_element) {
				return $.contains(ele_par[0], jquery_element[0]) || ele_par.is(jquery_element);
			}

			function set_value(event, close) {
				// use input values to set the time
				var tim = ele_next.find(".ti_tx input").val();
				var mini = ele_next.find(".mi_tx input").val();
				var meri = "";
				if(settings.show_meridian){
					meri = ele_next.find(".mer_tx input").val();
				}
				
				if (tim.length !== 0 && mini.length !== 0 && (!settings.show_meridian || meri.length !== 0)) {
					// store the value so we can set the initial value
					// next time the picker is opened
					ele.attr('data-timepicki-tim', tim);
					ele.attr('data-timepicki-mini', mini);
					
					if(settings.show_meridian){
						ele.attr('data-timepicki-meri', meri);
						// set the formatted value
						ele.val(settings.format_output(tim, mini, meri));
					}else{
						ele.val(settings.format_output(tim, mini));
					}
				}

				//Call user on_change callback function if set
				if (settings.on_change !== null) {
					settings.on_change(ele[0]);
				}

				if (close) {
					close_timepicki();
				}
			}

			function open_timepicki() {
				set_date(settings.start_time);
				ele_next.fadeIn();
				// focus on the first input and select its contents
				var first_input = ele_next.find('input:visible').first();
				first_input.focus();
				// if the user presses shift+tab while on the first input,
				// they mean to exit the time picker and go to the previous field
				var first_input_exit_handler = function(e) {
					if (e.which === 9 && e.shiftKey) {
						first_input.off('keydown', first_input_exit_handler);
						var all_form_elements = $(':input:visible:not(.timepicki-input)');
						var index_of_timepicki_input = all_form_elements.index(ele);
						var previous_form_element = all_form_elements.get(index_of_timepicki_input-1);
						previous_form_element.focus();
					}
				};
				first_input.on('keydown', first_input_exit_handler);
			}

			function close_timepicki() {
				ele_next.fadeOut();
			}

			function set_date(start_time) {
				var d, ti, mi, mer;

				// if a value was already picked we will remember that value
				if (ele.is('[data-timepicki-tim]')) {
					ti = Number(ele.attr('data-timepicki-tim'));
					mi = Number(ele.attr('data-timepicki-mini'));
					if(settings.show_meridian){
						mer = ele.attr('data-timepicki-meri');
					}
				// developer can specify a custom starting value
				} else if (typeof start_time === 'object') {
					ti = Number(start_time[0]);
					mi = Number(start_time[1]);
					if(settings.show_meridian){
						mer = start_time[2];
					}
				// default is we will use the current time
				} else {
					d = new Date();
					ti = d.getHours();
					mi = d.getMinutes();
					mer = "AM";
					if (12 < ti  && settings.show_meridian) {
						ti -= 12;
						mer = "PM";
					}
				}

				if (ti < 10) {
					ele_next.find(".ti_tx input").val("0" + ti);
				} else {
					ele_next.find(".ti_tx input").val(ti);
				}
				if (mi < 10) {
					ele_next.find(".mi_tx input").val("0" + mi);
				} else {
					ele_next.find(".mi_tx input").val(mi);
				}
				if(settings.show_meridian){
					if (mer < 10) {
						ele_next.find(".mer_tx input").val("0" + mer);
					} else {
						ele_next.find(".mer_tx input").val(mer);
					}
				}
			}

			function change_time(cur_ele, direction) {
				var cur_cli = "time";
				var cur_time = Number(ele_next.find("." + cur_cli + " .ti_tx input").val());
				var ele_st = Number(settings.min_hour_value);
				var ele_en = Number(settings.max_hour_value);
				var step_size = Number(settings.step_size_hours);
				if ((cur_ele && cur_ele.hasClass('action-next')) || direction === 'next') {
					if (cur_time + step_size > ele_en) {
						var min_value = ele_st;
						if (min_value < 10) {
							min_value = '0' + min_value;
						} else {
							min_value = String(min_value);
						}
						ele_next.find("." + cur_cli + " .ti_tx input").val(min_value);
					} else {
						cur_time = cur_time + step_size;
						if (cur_time < 10) {
							cur_time = "0" + cur_time;
						}
						ele_next.find("." + cur_cli + " .ti_tx input").val(cur_time);
					}
				} else if ((cur_ele && cur_ele.hasClass('action-prev')) || direction === 'prev') {
					var minValue = Number(settings.min_hour_value)
					if (cur_time - step_size < minValue) {
						var max_value = ele_en;
						if (max_value < 10) {
							max_value = '0' + max_value;
						} else {
							max_value = String(max_value);
						}
						ele_next.find("." + cur_cli + " .ti_tx input").val(max_value);
					} else {
						cur_time = cur_time - step_size;
						if (cur_time < 10) {
							cur_time = "0" + cur_time;
						}
						ele_next.find("." + cur_cli + " .ti_tx input").val(cur_time);
					}
				}
			}

			function change_mins(cur_ele, direction) {
				var cur_cli = "mins";
				var cur_mins = Number(ele_next.find("." + cur_cli + " .mi_tx input").val());
				var ele_st = 0;
				var ele_en = 59;
				var step_size = Number(settings.step_size_minutes);
				if ((cur_ele && cur_ele.hasClass('action-next')) || direction === 'next') {
					if (cur_mins + step_size > ele_en) {
						ele_next.find("." + cur_cli + " .mi_tx input").val("00");
						if(settings.overflow_minutes){
							change_time(null, 'next');
						}
					} else {
						cur_mins = cur_mins + step_size;
						if (cur_mins < 10) {
							ele_next.find("." + cur_cli + " .mi_tx input").val("0" + cur_mins);
						} else {
							ele_next.find("." + cur_cli + " .mi_tx input").val(cur_mins);
						}
					}
				} else if ((cur_ele && cur_ele.hasClass('action-prev')) || direction === 'prev') {
					if (cur_mins - step_size <= -1) {
						ele_next.find("." + cur_cli + " .mi_tx input").val(ele_en + 1 - step_size);
						if(settings.overflow_minutes){
							change_time(null, 'prev');
						}
					} else {
						cur_mins = cur_mins - step_size;
						if (cur_mins < 10) {
							ele_next.find("." + cur_cli + " .mi_tx input").val("0" + cur_mins);
						} else {
							ele_next.find("." + cur_cli + " .mi_tx input").val(cur_mins);
						}
					}
				}
			}

			function change_meri(cur_ele, direction) {
				var cur_cli = "meridian";
				var ele_st = 0;
				var ele_en = 1;
				var cur_mer = null;
				cur_mer = ele_next.find("." + cur_cli + " .mer_tx input").val();
				if ((cur_ele && cur_ele.hasClass('action-next')) || direction === 'next') {
					if (cur_mer == "AM") {
						ele_next.find("." + cur_cli + " .mer_tx input").val("PM");
					} else {
						ele_next.find("." + cur_cli + " .mer_tx input").val("AM");
					}
				} else if ((cur_ele && cur_ele.hasClass('action-prev')) || direction === 'prev') {
					if (cur_mer == "AM") {
						ele_next.find("." + cur_cli + " .mer_tx input").val("PM");
					} else {
						ele_next.find("." + cur_cli + " .mer_tx input").val("AM");
					}
				}
			}

			// handle clicking on the arrow icons
			var cur_next = ele_next.find(".action-next");
			var cur_prev = ele_next.find(".action-prev");
			$(cur_prev).add(cur_next).on("click", function() {
				var cur_ele = $(this);
				if (cur_ele.parent().attr("class") == "time") {
					change_time(cur_ele);
				} else if (cur_ele.parent().attr("class") == "mins") {
					change_mins(cur_ele);
				} else {
					if(settings.show_meridian){
						change_meri(cur_ele);
					}
				}
			});

		});
	};

}(jQuery));
